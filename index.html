<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫¢NG KPI PH·ª§ TR√ÅCH K·∫æ TO√ÅN - IDECO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- QuillJS Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; }
        .table-container { overflow-x: auto; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; vertical-align: top; }
        th { background: #4f46e5; color: white; position: sticky; top: 0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background:rgba(0,0,0,0.5);}
        .modal-content { background: #fff; margin: 10% auto; padding: 24px; border-radius: 8px; width: 90%; max-width: 600px;}
        .action-button { background: #4f46e5; color: white; padding: 10px 18px; border-radius: 6px; font-weight: 500; border:none; cursor:pointer; }
        .action-button:hover { background: #4338ca; }
        .danger-button { background: #ef4444; }
        .danger-button:hover { background: #dc2626; }
        .secondary-button { background: #6b7280; }
        .secondary-button:hover { background: #4b5563; }
        .framed-info { border: 2px solid #6366f1; border-radius: 14px; background: #f5f3ff; box-shadow: 0 1px 8px #d1d5db33; }
        /* Quill resize */
        .quill-editor {
            min-height: 90px;
            resize: vertical;
            overflow: auto;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 100%;
            margin-bottom: 16px;
        }
        .ql-toolbar.ql-snow {
            border-radius: 8px 8px 0 0;
        }
        .ql-container.ql-snow {
            border-radius: 0 0 8px 8px;
        }
        .total-score-box {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.2);
        }
        .score-input {
            width: 100%;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            background: #f9fafb;
        }
        .score-input:focus {
            outline: none;
            border-color: #4f46e5;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .table-score {
            font-weight: bold;
            color: #4f46e5;
        }
        .table-total {
            background: #f8fafc;
            font-weight: bold;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- FORM KPI -->
    <div class="container mx-auto bg-white p-6 md:p-8 rounded-lg shadow-xl" id="mainKpiForm" style="display: none;">
        <h1 class="text-3xl font-bold text-center mb-8 text-indigo-700">B·∫¢NG KPI PH·ª§ TR√ÅCH K·∫æ TO√ÅN</h1>
        
        <!-- Th√¥ng tin ng∆∞·ªùi l·∫≠p -->
        <div class="framed-info p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label for="creatorName" class="block text-sm font-medium text-gray-700 mb-1">T√™n ng∆∞·ªùi l·∫≠p:</label>
                <input type="text" id="creatorName" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm">
            </div>
            <div>
                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">B·ªô ph·∫≠n:</label>
                <input type="text" id="department" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm">
            </div>
            <div>
                <label for="creationDate" class="block text-sm font-medium text-gray-700 mb-1">Ng√†y l·∫≠p:</label>
                <input type="date" id="creationDate" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm">
            </div>
        </div>

        <!-- B·∫¢NG 1: KPI HO√ÄN TH√ÄNH NHI·ªÜM V·ª§ GIAO -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">KPI HO√ÄN TH√ÄNH NHI·ªÜM V·ª§ GIAO TRONG K·ª≤ (10%)</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-4">
                <table id="kpiTable" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Ch·ªâ s·ªë KPI</th>
                            <th>ƒê·∫°t ch·ªâ s·ªë</th>
                            <th>ƒêi·ªÉm KPI %</th>
                            <th>ƒê√°nh gi√° ƒëi·ªÉm</th>
                            <th>B√°o c√°o</th>
                            <th>X√≥a</th>
                        </tr>
                    </thead>
                    <tbody id="kpiTableBody"></tbody>
                    <tfoot>
                        <tr class="table-total">
                            <td colspan="3" class="text-right font-bold">T·ªïng B·∫£ng 1:</td>
                            <td class="text-center font-bold text-indigo-600" id="table1-total">0</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <button id="addRowBtn" class="action-button">Th√™m h√†ng KPI</button>
        </div>

        <!-- B·∫¢NG 2: KPI K·∫æ TO√ÅN B√ÅN H√ÄNG -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-indigo-300 shadow-md">
            <h2 class="text-2xl font-bold text-indigo-700 mb-6">A. KPI K·∫æ TO√ÅN B√ÅN H√ÄNG</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable2" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Ch·ªâ s·ªë KPI</th>
                            <th>ƒê·∫°t ch·ªâ s·ªë</th>
                            <th>ƒêi·ªÉm KPI %</th>
                            <th>ƒê√°nh gi√° ƒëi·ªÉm</th>
                            <th>B√°o c√°o</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><b style="color: red;">1 Xu·∫•t h√≥a ƒë∆°n b√°n h√†ng.</b></td>
                            <td>ƒê√∫ng th·ªùi ƒëi·ªÉm trong k·ª≥ - ƒë·ªß - ch√≠nh x√°c</td>
                            <td style="color:red; font-weight:bold;" class="kpi2-score">10%</td>
                            <td><input class="kpi2-evaluation score-input" type="number" value="0" min="0" max="10"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em t·ª± ƒë√°nh gi√°</textarea></td>
                        </tr>
                        <tr>
                            <td>2 H·∫°ch to√°n b√°n h√†ng ƒë√∫ng.</td>
                            <td>Khai b√°o ƒë√∫ng ƒë·ªãnh kho·∫£n - ƒë·ªïi tr·∫£ h√†ng t·ª´ kh√°ch h√†ng ƒë√∫ng nghi·ªáp v·ª•</td>
                            <td class="kpi2-score">10%</td>
                            <td><input class="kpi2-evaluation score-input" type="number" value="0" min="0" max="10"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em t·ª± ƒë√°nh gi√°</textarea></td>
                        </tr>
                        <tr>
                            <td><b style="color: red;">3 Checklist c√¥ng vi·ªác trong k·ª≥ t·ªët.</b></td>
                            <td>ƒê·∫°t t·ª´ 5%</td>
                            <td style="color:red; font-weight:bold;" class="kpi2-score">15%</td>
                            <td><input class="kpi2-evaluation score-input" type="number" value="0" min="0" max="15"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em t·ª± ƒë√°nh gi√°</textarea></td>
                        </tr>
                        <tr>
                            <td><b style="color: red;">4. Ch·∫•t l∆∞·ª£ng nghi·ªáp v·ª•.</b></td>
                            <td>Sai s√≥t h√≥a ƒë∆°n - ƒëi·ªÅu ch·ªânh h√≥a ƒë∆°n nh·ªü h∆°n 1 l·ªói/ k·ª≥: L√¥ -H·∫°n d√πng</td>
                            <td style="color:red; font-weight:bold;" class="kpi2-score">15%</td>
                            <td><input class="kpi2-evaluation score-input" type="number" value="0" min="0" max="15"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em t·ª± ƒë√°nh gi√°</textarea></td>
                        </tr>
                        <tr>
                            <td><b style="color: red;">5. T√≠nh ph·ªëi h·ª£p v·ªõi b·ªô ph·∫≠n Sales - kho v·∫≠n.</b></td>
                            <td>Kh√¥ng √°ch t·∫Øt - ch·∫≠m tr·ªÖ do l·ªói ph√°t sinh</td>
                            <td style="color:red; font-weight:bold;" class="kpi2-score">10%</td>
                            <td><input class="kpi2-evaluation score-input" type="number" value="0" min="0" max="10"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em t·ª± ƒë√°nh gi√°</textarea></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-total">
                            <td colspan="3" class="text-right font-bold">T·ªïng B·∫£ng 2:</td>
                            <td class="text-center font-bold text-indigo-600" id="table2-total">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <!-- Editor B·∫¢NG 2 -->
            <div class="kpi2-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Ph√¢n t√≠ch b√°o c√°o cu·ªëi k·ª≥:</label>
                <div id="kpi2NoteEditor" class="quill-editor"></div>
            </div>
        </div>

        <!-- B·∫¢NG 3: KPI K·∫æ TO√ÅN KHO -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-green-300 shadow-md">
            <h2 class="text-2xl font-bold text-green-700 mb-6">B. KPI K·∫æ TO√ÅN KHO</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable3" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Ch·ªâ s·ªë KPI</th>
                            <th>ƒê·∫°t ch·ªâ s·ªë</th>
                            <th>ƒêi·ªÉm KPI %</th>
                            <th>ƒê√°nh gi√° ƒëi·ªÉm</th>
                            <th>B√°o c√°o</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1. H·∫°ch to√°n xu·∫•t - nh·∫≠p c√°c ch·ª©ng t·ª´ ph√°t sinh v√†o h·ªá th·ªëng Misa- ERP.</td>
                            <td>Kh·ªõp- ƒë√∫ng h·∫°n</td>
                            <td style="color:red; font-weight:bold;" class="kpi3-score">10%</td>
                            <td><input class="kpi3-evaluation score-input" type="number" value="0" min="0" max="10"></td>
                            <td><textarea class="kpi3-report w-full border rounded-md p-1" rows="1">Em t·ª± ƒë√°nh gi√°</textarea></td>
                        </tr>
                        <tr>
                            <td>2 T·ªâ l·ªá sai l·ªách d·ªØ li·ªáu kho Misa -ERP khi ki·ªÉm kho c√≥ ƒëi·ªÅu ch·ªânh.</td>
                            <td>D∆∞·ªõi 3% khi ƒë√°nh gi√° ki·ªÉm ( t√≠nh ƒëi·ªÉm k·ª≥ tr∆∞·ªõc ki·ªÉm tra cho k·ª≥ n√†y v√† l≈©y k·∫ø t√≠nh ti·∫øp theo)</td>
                            <td style="color:red; font-weight:bold;" class="kpi3-score">10%</td>
                            <td><input class="kpi3-evaluation score-input" type="number" value="0" min="0" max="10"></td>
                            <td><textarea class="kpi3-report w-full border rounded-md p-1" rows="1">Em t·ª± ƒë√°nh gi√°</textarea></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-total">
                            <td colspan="3" class="text-right font-bold">T·ªïng B·∫£ng 3:</td>
                            <td class="text-center font-bold text-indigo-600" id="table3-total">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <!-- Editor B·∫¢NG 3 -->
            <div class="kpi3-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Ph√¢n t√≠ch b√°o c√°o cu·ªëi k·ª≥:</label>
                <div id="kpi3NoteEditor" class="quill-editor"></div>
            </div>
        </div>

        <!-- B·∫¢NG 4: KPI C√îNG N·ª¢ - QU·∫¢N L√ù ƒê·ªêI CHI·∫æU -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-blue-300 shadow-md">
            <h2 class="text-2xl font-bold text-blue-700 mb-6">C. KPI C√îNG N·ª¢ - QU·∫¢N L√ù ƒê·ªêI CHI·∫æU</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable4" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Ch·ªâ s·ªë KPI</th>
                            <th>ƒê·∫°t ch·ªâ s·ªë</th>
                            <th>ƒêi·ªÉm KPI %</th>
                            <th>ƒê√°nh gi√° ƒëi·ªÉm</th>
                            <th>B√°o c√°o</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><b style="color:green;">1 H·∫°ch to√°n - ƒë·ªëi chi·∫øu c√¥ng n·ª£.</b></td>
                            <td>ƒê√∫ng nghi·ªáp v·ª• - s√°t v·ªõi s·ªë li·ªáu khai b√°o - kh·ªõp v·ªõi th√¥ng tin tr·∫£ n·ª£</td>
                            <td class="kpi4-score">10%</td>
                            <td><input class="kpi4-evaluation score-input" type="number" value="0" min="0" max="10"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em t·ª± ƒë√°nh gi√°</textarea></td>
                        </tr>
                        <tr>
                            <td><b style="color:green;">2 C√¥ng n·ª£ qu√° h·∫°n kh√¥ng th√¥ng b√°o</b></td>
                            <td>Ph√°t sinh h√≥a ƒë∆°n ƒë·∫øn h·∫°n thanh to√°n qu√° tr√™n 20 c√≥ t·ªëi ƒëa 1 h√≥a ƒë∆°n trong k·ª≥</td>
                            <td style="color:red; font-weight:bold;" class="kpi4-score">10%</td>
                            <td><input class="kpi4-evaluation score-input" type="number" value="0" min="0" max="15"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em t·ª± ƒë√°nh gi√°</textarea></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-total">
                            <td colspan="3" class="text-right font-bold">T·ªïng B·∫£ng 4:</td>
                            <td class="text-center font-bold text-indigo-600" id="table4-total">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="kpi4-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Ph√¢n t√≠ch b√°o c√°o cu·ªëi k·ª≥:</label>
                <div id="kpi4NoteEditor" class="quill-editor"></div>
            </div>
        </div>

        <!-- QUY ƒê·ªäNH TH∆Ø·ªûNG -->
        <div class="mt-4 p-6 border border-dashed border-green-500 bg-green-50 rounded-xl shadow-sm">
            <div class="font-bold text-lg mb-4 text-green-700">QUY ƒê·ªäNH TH∆Ø·ªûNG KPI - T√çNH TH∆Ø·ªûNG HOA H·ªíNG</div>
            <div class="text-gray-700 leading-relaxed space-y-4">
                <p><b class="text-red-600">TH∆Ø·ªûNG N·ªñ L·ª∞C K·∫æ TO√ÅN KI·ªÇM SO√ÅT CHI PH√ç - L·ª¢I NHU·∫¨N T·ªêT NGO√ÄI CH·ªà S·ªê KPI</b></p>
                
                <p><b>√Åp d·ª•ng cho Qu·∫£n l√Ω K·∫ø to√°n ‚Äì K·∫ø to√°n vi√™n</b></p>
                
                <p><b>1. Th∆∞·ªüng d·ª±a tr√™n t·ª∑ l·ªá l·ª£i nhu·∫≠n k·∫ø to√°n:</b><br>
                X√©t theo t·ª∑ l·ªá: <b>[L·ª£i nhu·∫≠n k·∫ø to√°n tr∆∞·ªõc thu·∫ø] / [T·ªïng doanh thu thu·∫ßn]</b> trong k·ª≥.</p>
                
                <p><b>- M·ª©c th∆∞·ªüng theo t·ª∑ l·ªá ƒë·∫°t ƒë∆∞·ª£c:</b><br>
                ‚Ä¢ ƒê·∫°t t·ª´ 6%: Qu·∫£n l√Ω th∆∞·ªüng 300,000 VNƒê ‚Äî K·∫ø to√°n vi√™n th∆∞·ªüng 200,000 VNƒê.<br>
                ‚Ä¢ ƒê·∫°t t·ª´ 8%: Qu·∫£n l√Ω th∆∞·ªüng 500,000 VNƒê ‚Äî K·∫ø to√°n vi√™n th∆∞·ªüng 300,000 VNƒê.<br>
                ‚Ä¢ ƒê·∫°t t·ª´ 12%: Qu·∫£n l√Ω th∆∞·ªüng 800,000 VNƒê ‚Äî K·∫ø to√°n vi√™n th∆∞·ªüng 500,000 VNƒê.</p>
                
                <p><b>2. L∆∞u √Ω √°p d·ª•ng:</b><br>
                ‚Ä¢ <b>Ri√™ng v·ªõi k·∫ø to√°n vi√™n:</b> T·ª∑ l·ªá ƒë∆∞·ª£c t√≠nh <b>so s√°nh v·ªõi k·ª≥ tr∆∞·ªõc</b> ƒë·ªÉ ƒë√°nh gi√° v√† x√©t th∆∞·ªüng.<br>
                ‚Ä¢ M·ª©c th∆∞·ªüng c√≥ th·ªÉ ƒë∆∞·ª£c <b>l≈©y k·∫ø t√≠nh cho c√°c k·ª≥ ti·∫øp theo</b> theo quy ƒë·ªãnh c·ª• th·ªÉ.<br>
                ‚Ä¢ K·∫øt qu·∫£ ph·∫£i d·ª±a tr√™n b√°o c√°o t√†i ch√≠nh ƒë√£ ƒë∆∞·ª£c ki·ªÉm tra v√† x√°c nh·∫≠n.</p>
                
                <p><b class="text-red-600">ƒêI·ªÇM KPI CHO K·∫æ TO√ÅN S·∫º B·ªä GI·∫¢M TR·ª™ ƒêI·ªÇM KHI ƒê√ÅNH GI√Å TRONG K·ª≤ TH√ÅNG</b></p>
                
                <p><b>1.</b> L·ªói sai s√≥t xu·∫•t ch·ª©ng t·ª´ h√≥a ƒë∆°n ph·∫£i bu·ªôt ƒëi·ªÅu ch·ªânh sai s√≥t <b>Tr·ª´ 10% ƒëi·ªÉm KPI/ h√≥a ƒë∆°n</b>.</p>
                <p><b>2.</b> L·ªói sai s√≥t nh·∫≠p - xu·∫•t phi·∫øu kho h√†ng h√≥a - s·ªë li·ªáu nh·∫≠p xu·∫•t kho sai <b>Tr·ª´ 10% ƒëi·ªÉm KPI/ l·ªói sai s√≥t</b></p>
                <p><b>3.</b> L·ªói b√°o c√°o Cu·ªëi Th√°ng theo quy ƒë·ªãnh tr·ªÖ hay b·ªã bu·ªôt ph·∫£i l√†m l·∫°i do sai s√≥t nhi·ªÅu <b>Tr·ª´ 8% ƒëi·ªÉm KPI</b>.</p>
                <p><b>4.</b> L·ªói nh·∫≠p sai s√≥t h·∫°ch to√°n s·ªï s√°ch k·∫ø to√°n trong k·ª≥ ph√°t hi·ªán <b>Tr·ª´ 8% ƒëi·ªÉm KPI</b>.</p>
                <p><b>5.</b> L·ªói kh√¥ng tu√¢n th·ªß ch·ªâ ƒë·∫°o c·∫•p tr√™n - t·ª± √Ω l√†m sai nguy√™n t·∫Øc t·ªï ch·ª©c <b>Tr·ª´ 15% ƒëi·ªÉm KPI</b>.</p>
            </div>
        </div>

        <!-- T·ªîNG ƒêI·ªÇM KPI -->
        <div class="total-score-box mt-8">
            <h3 class="text-2xl font-bold mb-4">T·ªîNG ƒêI·ªÇM KPI ƒê√ÅNH GI√Å</h3>
            <div class="text-5xl font-bold mb-2" id="total-evaluation-score">0</div>
            <p class="text-lg mb-4 opacity-90">ƒêi·ªÉm t·ªïng h·ª£p t·ª´ t·∫•t c·∫£ c√°c b·∫£ng KPI</p>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-white/20 p-3 rounded-lg">
                    <div class="text-sm opacity-90">B·∫£ng 1</div>
                    <div class="text-xl font-bold" id="score-table1">0</div>
                    <div class="text-xs">Nhi·ªám v·ª• giao</div>
                </div>
                <div class="bg-white/20 p-3 rounded-lg">
                    <div class="text-sm opacity-90">B·∫£ng 2</div>
                    <div class="text-xl font-bold" id="score-table2">0</div>
                    <div class="text-xs">K·∫ø to√°n b√°n h√†ng</div>
                </div>
                <div class="bg-white/20 p-3 rounded-lg">
                    <div class="text-sm opacity-90">B·∫£ng 3</div>
                    <div class="text-xl font-bold" id="score-table3">0</div>
                    <div class="text-xs">K·∫ø to√°n kho</div>
                </div>
                <div class="bg-white/20 p-3 rounded-lg">
                    <div class="text-sm opacity-90">B·∫£ng 4</div>
                    <div class="text-xl font-bold" id="score-table4">0</div>
                    <div class="text-xs">C√¥ng n·ª£ - ƒê·ªëi chi·∫øu</div>
                </div>
            </div>
        </div>

        <!-- N√öT H√ÄNH ƒê·ªòNG -->
        <div class="flex flex-wrap gap-4 justify-center md:justify-start mt-8">
            <button id="saveKpiBtn" class="action-button">üíæ L∆∞u l·∫°i</button>
            <button id="exportPdfBtn" class="action-button secondary-button">üìÑ Xu·∫•t file PDF</button>
            <button id="exportHtmlBtn" class="action-button secondary-button">üì§ Xu·∫•t file g·ªüi ƒëi·ªÉm KPI</button>
            <button id="backToListBtn" class="action-button secondary-button">‚Üê Quay l·∫°i Danh s√°ch</button>
        </div>
    </div>

    <!-- MODAL DANH S√ÅCH KPI -->
    <div id="kpiListModal" class="modal">
        <div class="modal-content">
            <span class="float-right text-xl cursor-pointer hover:text-red-500" id="closeModalBtn">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">B·∫¢NG KPI PH·ª§ TR√ÅCH K·∫æ TO√ÅN</h2>
            <button id="addNewKpiFromModalBtn" class="action-button mb-6 w-full">‚ûï Th√™m m·ªõi B·∫£ng KPI</button>
            <a href="https://erp-ideco.skyit.vn/#/app/dashboard/main" target="_blank" class="action-button secondary-button mb-4 w-full text-center block">üè† ERP HOME</a>
            <div id="savedKpiList" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

<script>
// --- Firebase config ---
const firebaseConfig = {
    apiKey: "AIzaSyCC2KUiYoGrEWl3GUCk2xUoUU_TQTX-0rw",
    authDomain: "kpi-7d405.firebaseapp.com",
    databaseURL: "https://kpi-7d405-default-rtdb.firebaseio.com",
    projectId: "kpi-7d405",
    storageBucket: "kpi-7d405.appspot.com",
    messagingSenderId: "408635637678",
    appId: "1:408635637678:web:435407046d80ddc42cd23f",
    measurementId: "G-Y9KH6RT5V0"
};

// Kh·ªüi t·∫°o Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Bi·∫øn to√†n c·ª•c
const mainKpiForm = document.getElementById('mainKpiForm');
const kpiTableBody = document.getElementById('kpiTableBody');
const addRowBtn = document.getElementById('addRowBtn');
const saveKpiBtn = document.getElementById('saveKpiBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const exportHtmlBtn = document.getElementById('exportHtmlBtn');
const backToListBtn = document.getElementById('backToListBtn');
const kpiListModal = document.getElementById('kpiListModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const savedKpiListDiv = document.getElementById('savedKpiList');
const addNewKpiFromModalBtn = document.getElementById('addNewKpiFromModalBtn');
let currentKpiId = null;

// --- QuillJS Editor config ---
const quillToolbar = [
    ['bold', 'italic', 'underline', 'strike'],
    [{ 'font': [] }],
    [{ 'size': ['small', false, 'large', 'huge'] }],
    [{ 'align': [] }],
    [{ 'color': [] }, { 'background': [] }],
    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
    ['clean']
];

let kpi2NoteEditor, kpi3NoteEditor, kpi4NoteEditor;

// Kh·ªüi t·∫°o editors
function initEditors() {
    kpi2NoteEditor = new Quill('#kpi2NoteEditor', {
        modules: { toolbar: quillToolbar },
        theme: 'snow'
    });
    kpi3NoteEditor = new Quill('#kpi3NoteEditor', {
        modules: { toolbar: quillToolbar },
        theme: 'snow'
    });
    kpi4NoteEditor = new Quill('#kpi4NoteEditor', {
        modules: { toolbar: quillToolbar },
        theme: 'snow'
    });
}

// Reset editors
function resetEditors() {
    kpi2NoteEditor.root.innerHTML = '';
    kpi3NoteEditor.root.innerHTML = '';
    kpi4NoteEditor.root.innerHTML = '';
}

// --- H√ÄM T√çNH TO√ÅN ƒêI·ªÇM HO√ÄN CH·ªàNH ---
function calcTotalEvaluationScore() {
    let sumTable1 = 0;
    let sumTable2 = 0;
    let sumTable3 = 0;
    let sumTable4 = 0;
    
    // B·∫£ng 1 (ƒë·ªông) - KPI HO√ÄN TH√ÄNH NHI·ªÜM V·ª§ GIAO
    document.querySelectorAll('#kpiTableBody .scoreEvaluation').forEach(input => {
        let val = parseFloat(input.value) || 0;
        sumTable1 += val;
    });
    
    // B·∫£ng 2 (tƒ©nh) - KPI K·∫æ TO√ÅN B√ÅN H√ÄNG
    document.querySelectorAll('#kpiTable2 .kpi2-evaluation').forEach(input => {
        let val = parseFloat(input.value) || 0;
        sumTable2 += val;
    });
    
    // B·∫£ng 3 (tƒ©nh) - KPI K·∫æ TO√ÅN KHO
    document.querySelectorAll('#kpiTable3 .kpi3-evaluation').forEach(input => {
        let val = parseFloat(input.value) || 0;
        sumTable3 += val;
    });
    
    // B·∫£ng 4 (tƒ©nh) - KPI C√îNG N·ª¢ - QU·∫¢N L√ù ƒê·ªêI CHI·∫æU
    document.querySelectorAll('#kpiTable4 .kpi4-evaluation').forEach(input => {
        let val = parseFloat(input.value) || 0;
        sumTable4 += val;
    });
    
    // T√≠nh t·ªïng chung
    const totalScore = sumTable1 + sumTable2 + sumTable3 + sumTable4;
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
    document.getElementById('table1-total').textContent = sumTable1.toFixed(2);
    document.getElementById('table2-total').textContent = sumTable2.toFixed(2);
    document.getElementById('table3-total').textContent = sumTable3.toFixed(2);
    document.getElementById('table4-total').textContent = sumTable4.toFixed(2);
    
    document.getElementById('total-evaluation-score').textContent = totalScore.toFixed(2);
    document.getElementById('score-table1').textContent = sumTable1.toFixed(2);
    document.getElementById('score-table2').textContent = sumTable2.toFixed(2);
    document.getElementById('score-table3').textContent = sumTable3.toFixed(2);
    document.getElementById('score-table4').textContent = sumTable4.toFixed(2);
    
    return totalScore;
}

// Th√™m s·ª± ki·ªán cho t·∫•t c·∫£ c√°c input ƒëi·ªÉm
function addEvaluationInputEvents() {
    // B·∫£ng 1
    kpiTableBody.addEventListener('input', e => {
        if (e.target.classList.contains('scoreEvaluation')) {
            calcTotalEvaluationScore();
        }
    });
    
    // B·∫£ng 2
    document.querySelectorAll('#kpiTable2 .kpi2-evaluation').forEach(input => {
        input.addEventListener('input', calcTotalEvaluationScore);
    });
    
    // B·∫£ng 3
    document.querySelectorAll('#kpiTable3 .kpi3-evaluation').forEach(input => {
        input.addEventListener('input', calcTotalEvaluationScore);
    });
    
    // B·∫£ng 4
    document.querySelectorAll('#kpiTable4 .kpi4-evaluation').forEach(input => {
        input.addEventListener('input', calcTotalEvaluationScore);
    });
}

// Th√™m h√†ng m·ªõi v√†o b·∫£ng 1
function addKpiRow(data = {}) {
    const row = kpiTableBody.insertRow();
    row.innerHTML = `
        <td><textarea class="kpiIndicator w-full p-2 border rounded-md" placeholder="M√¥ t·∫£ ch·ªâ s·ªë">${data.kpiIndicator||''}</textarea></td>
        <td><input type="text" class="achievedIndicator w-full p-2 border rounded-md" value="${data.achievedIndicator||''}" placeholder="M√¥ t·∫£ ƒë·∫°t ch·ªâ s·ªë"></td>
        <td><input type="number" class="kpiScore w-full p-2 border rounded-md" value="${data.kpiScore||''}" placeholder="ƒêi·ªÉm KPI %"></td>
        <td><input type="number" class="scoreEvaluation score-input" value="${data.scoreEvaluation||'0'}" placeholder="ƒê√°nh gi√° ƒëi·ªÉm"></td>
        <td><textarea class="reportNotes w-full p-2 border rounded-md" placeholder="B√°o c√°o chi ti·∫øt">${data.reportNotes||''}</textarea></td>
        <td class="text-center"><button class="deleteRowBtn danger-button text-xs px-2 py-1">üóëÔ∏è X√≥a</button></td>
    `;
    
    // Th√™m s·ª± ki·ªán x√≥a
    row.querySelector('.deleteRowBtn').onclick = () => {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h√†ng KPI n√†y?')) {
            row.remove();
            calcTotalEvaluationScore();
        }
    };
    
    // Th√™m s·ª± ki·ªán t√≠nh ƒëi·ªÉm
    const scoreInput = row.querySelector('.scoreEvaluation');
    scoreInput.addEventListener('input', calcTotalEvaluationScore);
}

// --- QU·∫¢N L√ù FORM ---
function showForm() { 
    mainKpiForm.style.display = 'block'; 
    kpiListModal.style.display = 'none';
}
function hideForm() { 
    mainKpiForm.style.display = 'none'; 
    kpiListModal.style.display = 'block';
}
function openModal() { 
    displaySavedKpis(); 
    kpiListModal.style.display = 'block';
    mainKpiForm.style.display = 'none';
}
function closeModal() { 
    kpiListModal.style.display = 'none'; 
}

// T·∫°o ID m·ªõi
function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9) + Date.now();
}

// Reset form
function resetMainFormAndShow() {
    // Reset th√¥ng tin c∆° b·∫£n
    document.getElementById('creatorName').value = '';
    document.getElementById('department').value = '';
    document.getElementById('creationDate').valueAsDate = new Date();
    
    // Reset b·∫£ng 1
    kpiTableBody.innerHTML = '';
    addKpiRow();
    
    // Reset c√°c b·∫£ng tƒ©nh
    document.querySelectorAll('.kpi2-evaluation, .kpi3-evaluation, .kpi4-evaluation').forEach(input => {
        input.value = '0';
    });
    
    // Reset c√°c textarea b√°o c√°o
    document.querySelectorAll('.kpi2-report, .kpi3-report, .kpi4-report, .reportNotes').forEach(textarea => {
        textarea.value = 'Em t·ª± ƒë√°nh gi√°';
    });
    
    // Reset editors
    resetEditors();
    
    currentKpiId = null;
    showForm();
    calcTotalEvaluationScore();
}

// --- L∆ØU D·ªÆ LI·ªÜU ---
function saveKpiData() {
    const creatorName = document.getElementById('creatorName').value.trim();
    const department = document.getElementById('department').value.trim();
    const creationDate = document.getElementById('creationDate').value;
    
    if (!creatorName || !department || !creationDate) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n ng∆∞·ªùi l·∫≠p, B·ªô ph·∫≠n v√† Ng√†y l·∫≠p.');
        return false;
    }
    
    // Thu th·∫≠p d·ªØ li·ªáu b·∫£ng 1
    const kpiRowsData = [];
    const rows = kpiTableBody.querySelectorAll('tr');
    rows.forEach(row => {
        const kpiIndicator = row.querySelector('.kpiIndicator');
        if (kpiIndicator && kpiIndicator.value.trim()) {
            kpiRowsData.push({
                kpiIndicator: kpiIndicator.value.trim(),
                achievedIndicator: row.querySelector('.achievedIndicator').value.trim(),
                kpiScore: row.querySelector('.kpiScore').value,
                scoreEvaluation: row.querySelector('.scoreEvaluation').value,
                reportNotes: row.querySelector('.reportNotes').value.trim(),
            });
        }
    });
    
    // Thu th·∫≠p d·ªØ li·ªáu c√°c b·∫£ng tƒ©nh
    const kpi2Evaluations = Array.from(document.querySelectorAll('#kpiTable2 .kpi2-evaluation')).map(el => el.value);
    const kpi3Evaluations = Array.from(document.querySelectorAll('#kpiTable3 .kpi3-evaluation')).map(el => el.value);
    const kpi4Evaluations = Array.from(document.querySelectorAll('#kpiTable4 .kpi4-evaluation')).map(el => el.value);
    
    // L·∫•y n·ªôi dung editors
    const kpi2Note = kpi2NoteEditor.root.innerHTML;
    const kpi3Note = kpi3NoteEditor.root.innerHTML;
    const kpi4Note = kpi4NoteEditor.root.innerHTML;
    
    // T√≠nh t·ªïng ƒëi·ªÉm
    const totalScore = calcTotalEvaluationScore();
    
    // T·∫°o d·ªØ li·ªáu l∆∞u
    let kpiData = {
        creatorName,
        department,
        creationDate,
        kpiRows: kpiRowsData,
        kpi2Evaluations,
        kpi3Evaluations,
        kpi4Evaluations,
        kpi2Note,
        kpi3Note,
        kpi4Note,
        totalScore,
        year: new Date().getFullYear(),
        id: currentKpiId || generateId(),
        lastModified: new Date().toISOString(),
        type: 'kpi_ketoan_vien'
    };
    
    // L∆∞u l√™n Firebase
    db.ref('kpiBoards_v3/' + kpiData.id).set(kpiData, err => {
        if (err) {
            alert('L·ªói khi l∆∞u l√™n server: ' + err.message);
            console.error(err);
        } else {
            alert('‚úÖ ƒê√£ l∆∞u b·∫£ng KPI th√†nh c√¥ng!');
            currentKpiId = kpiData.id;
            displaySavedKpis();
        }
    });
    
    return true;
}

// --- HI·ªÇN TH·ªä DANH S√ÅCH KPI ƒê√É L∆ØU ---
function displaySavedKpis() {
    savedKpiListDiv.innerHTML = '<p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</p>';
    
    db.ref('kpiBoards_v3').once('value', snapshot => {
        const kpisObj = snapshot.val() || {};
        const kpis = Object.values(kpisObj);
        
        savedKpiListDiv.innerHTML = '';
        
        if (kpis.length === 0) {
            savedKpiListDiv.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ b·∫£ng KPI n√†o ƒë∆∞·ª£c l∆∞u.</p>';
            return;
        }
        
        // S·∫Øp x·∫øp theo ng√†y t·∫°o m·ªõi nh·∫•t
        kpis.sort((a, b) => b.creationDate.localeCompare(a.creationDate));
        
        kpis.forEach(kpi => {
            const div = document.createElement('div');
            div.className = 'kpi-list-item p-4 border rounded-md shadow-sm flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition cursor-pointer';
            
            div.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-indigo-600">${kpi.creatorName || 'Ch∆∞a c√≥ t√™n'} (${kpi.year || new Date().getFullYear()})</p>
                    <p class="text-sm text-gray-600">${kpi.department || 'Ch∆∞a c√≥ b·ªô ph·∫≠n'} - ${kpi.creationDate || 'Ch∆∞a c√≥ ng√†y'}</p>
                    <p class="text-xs text-gray-500 mt-1">
                        <span class="font-bold ${kpi.totalScore >= 80 ? 'text-green-600' : kpi.totalScore >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                            T·ªïng ƒëi·ªÉm: ${kpi.totalScore || 0}
                        </span>
                    </p>
                </div>
                <button class="deleteSavedKpiBtn danger-button text-xs px-2 py-1 ml-2" data-id="${kpi.id}">üóëÔ∏è</button>
            `;
            
            // Click ƒë·ªÉ t·∫£i KPI
            div.onclick = () => loadKpiToForm(kpi.id);
            
            // X√≥a KPI
            div.querySelector('.deleteSavedKpiBtn').onclick = e => {
                e.stopPropagation();
                const password = prompt('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ x√°c nh·∫≠n x√≥a:');
                if (password !== 'minhtriet1973') {
                    alert('‚ùå Sai m·∫≠t kh·∫©u! Kh√¥ng ƒë∆∞·ª£c x√≥a.');
                    return;
                }
                
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£ng KPI n√†y?')) {
                    deleteKpi(kpi.id);
                }
            };
            
            savedKpiListDiv.appendChild(div);
        });
    });
}

// --- T·∫¢I KPI V√ÄO FORM ---
function loadKpiToForm(kpiId) {
    db.ref('kpiBoards_v3/' + kpiId).once('value', snap => {
        const kpi = snap.val();
        if (kpi) {
            currentKpiId = kpiId;
            
            // ƒêi·ªÅn th√¥ng tin c∆° b·∫£n
            document.getElementById('creatorName').value = kpi.creatorName || '';
            document.getElementById('department').value = kpi.department || '';
            document.getElementById('creationDate').value = kpi.creationDate || '';
            
            // ƒêi·ªÅn b·∫£ng 1
            kpiTableBody.innerHTML = '';
            (kpi.kpiRows || []).forEach(r => addKpiRow(r));
            if ((kpi.kpiRows || []).length === 0) addKpiRow();
            
            // ƒêi·ªÅn b·∫£ng 2
            if (kpi.kpi2Evaluations) {
                document.querySelectorAll('#kpiTable2 .kpi2-evaluation').forEach((el, index) => {
                    if (kpi.kpi2Evaluations[index] !== undefined) el.value = kpi.kpi2Evaluations[index];
                });
            }
            
            // ƒêi·ªÅn b·∫£ng 3
            if (kpi.kpi3Evaluations) {
                document.querySelectorAll('#kpiTable3 .kpi3-evaluation').forEach((el, index) => {
                    if (kpi.kpi3Evaluations[index] !== undefined) el.value = kpi.kpi3Evaluations[index];
                });
            }
            
            // ƒêi·ªÅn b·∫£ng 4
            if (kpi.kpi4Evaluations) {
                document.querySelectorAll('#kpiTable4 .kpi4-evaluation').forEach((el, index) => {
                    if (kpi.kpi4Evaluations[index] !== undefined) el.value = kpi.kpi4Evaluations[index];
                });
            }
            
            // ƒêi·ªÅn editors
            kpi2NoteEditor.root.innerHTML = kpi.kpi2Note || '';
            kpi3NoteEditor.root.innerHTML = kpi.kpi3Note || '';
            kpi4NoteEditor.root.innerHTML = kpi.kpi4Note || '';
            
            showForm();
            calcTotalEvaluationScore();
        }
    });
}

// --- X√ìA KPI ---
function deleteKpi(kpiIdToDelete) {
    db.ref('kpiBoards_v3/' + kpiIdToDelete).remove().then(() => {
        displaySavedKpis();
        if (currentKpiId === kpiIdToDelete) {
            currentKpiId = null;
            resetMainFormAndShow();
            hideForm();
            openModal();
        }
        alert('‚úÖ ƒê√£ x√≥a b·∫£ng KPI th√†nh c√¥ng!');
    }).catch(err => {
        alert('‚ùå L·ªói khi x√≥a: ' + err.message);
    });
}

// --- XU·∫§T PDF ---
document.getElementById('exportPdfBtn').onclick = function () {
    const creatorName = document.getElementById('creatorName').value.trim().replace(/[^a-zA-Z0-9]/g,'');
    const department = document.getElementById('department').value.trim().replace(/[^a-zA-Z0-9]/g,'');
    const creationDate = document.getElementById('creationDate').value;
    
    if (!creatorName || !department || !creationDate) {
        alert('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªß T√™n ng∆∞·ªùi l·∫≠p, B·ªô ph·∫≠n, Ng√†y l·∫≠p tr∆∞·ªõc khi xu·∫•t PDF!');
        return;
    }
    
    // ·∫®n c√°c n√∫t kh√¥ng c·∫ßn thi·∫øt
    const buttonsToHide = ['exportPdfBtn', 'exportHtmlBtn', 'saveKpiBtn', 'backToListBtn', 'addRowBtn'];
    const originalDisplay = {};
    
    buttonsToHide.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            originalDisplay[id] = btn.style.display;
            btn.style.display = 'none';
        }
    });
    
    const element = document.getElementById('mainKpiForm');
    const opt = {
        margin: [0.5, 0.5, 0.5, 0.5],
        filename: `KPI_${creatorName}_${department}_${creationDate}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
            scale: 2, 
            useCORS: true,
            backgroundColor: '#ffffff'
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait',
            compress: true
        },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };
    
    html2pdf().set(opt).from(element).save().then(() => {
        // Hi·ªán l·∫°i c√°c n√∫t
        buttonsToHide.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.style.display = originalDisplay[id] || '';
        });
        alert('‚úÖ ƒê√£ xu·∫•t PDF th√†nh c√¥ng!');
    });
};

// --- XU·∫§T HTML ---
document.getElementById('exportHtmlBtn').onclick = function() {
    const creatorName = document.getElementById('creatorName').value.trim();
    const department = document.getElementById('department').value.trim();
    const creationDate = document.getElementById('creationDate').value;
    
    if (!creatorName || !department || !creationDate) {
        alert('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªß T√™n ng∆∞·ªùi l·∫≠p, B·ªô ph·∫≠n, Ng√†y l·∫≠p tr∆∞·ªõc khi xu·∫•t HTML!');
        return;
    }
    
    // T·∫°o n·ªôi dung HTML tƒ©nh
    const htmlContent = `
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫¢NG KPI PH·ª§ TR√ÅCH K·∫æ TO√ÅN - ${creatorName}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        h1 { color: #4f46e5; text-align: center; margin-bottom: 30px; }
        .header-info { background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 5px solid #4f46e5; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th { background: #4f46e5; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border: 1px solid #ddd; }
        .total-score { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 25px; border-radius: 10px; text-align: center; margin: 30px 0; }
        .score-box { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .footer { text-align: center; margin-top: 40px; color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>B·∫¢NG KPI PH·ª§ TR√ÅCH K·∫æ TO√ÅN</h1>
        
        <div class="header-info">
            <h3>TH√îNG TIN NG∆Ø·ªúI L·∫¨P</h3>
            <p><strong>T√™n:</strong> ${creatorName}</p>
            <p><strong>B·ªô ph·∫≠n:</strong> ${department}</p>
            <p><strong>Ng√†y l·∫≠p:</strong> ${creationDate}</p>
            <p><strong>Ng√†y xu·∫•t b√°o c√°o:</strong> ${new Date().toLocaleDateString('vi-VN')}</p>
        </div>
        
        <div class="total-score">
            <h2>T·ªîNG ƒêI·ªÇM KPI ƒê√ÅNH GI√Å</h2>
            <h1 style="font-size: 48px; margin: 10px 0;">${calcTotalEvaluationScore()}</h1>
            <p>ƒêi·ªÉm t·ªïng h·ª£p t·ª´ t·∫•t c·∫£ c√°c b·∫£ng KPI</p>
        </div>
        
        <div class="score-box">
            <h3>CHI TI·∫æT ƒêI·ªÇM THEO B·∫¢NG</h3>
            <p><strong>B·∫£ng 1 - Nhi·ªám v·ª• giao:</strong> <span id="detail-table1">${document.getElementById('score-table1').textContent}</span></p>
            <p><strong>B·∫£ng 2 - K·∫ø to√°n b√°n h√†ng:</strong> <span id="detail-table2">${document.getElementById('score-table2').textContent}</span></p>
            <p><strong>B·∫£ng 3 - K·∫ø to√°n kho:</strong> <span id="detail-table3">${document.getElementById('score-table3').textContent}</span></p>
            <p><strong>B·∫£ng 4 - C√¥ng n·ª£ ƒë·ªëi chi·∫øu:</strong> <span id="detail-table4">${document.getElementById('score-table4').textContent}</span></p>
        </div>
        
        <p><em>ƒê√¢y l√† b√°o c√°o KPI ƒë√£ xu·∫•t t·ª´ h·ªá th·ªëng. Vui l√≤ng li√™n h·ªá qu·∫£n l√Ω ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.</em></p>
        
        <div class="footer">
            <hr>
            <p>H·ªá th·ªëng KPI - IDECO ¬© ${new Date().getFullYear()}</p>
            <p>B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng</p>
        </div>
    </div>
</body>
</html>`;
    
    // T·∫°o v√† t·∫£i file
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const a = document.createElement('a');
    const fileName = `KPI_${creatorName}_${department}_${creationDate}.html`;
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
    alert('‚úÖ ƒê√£ xu·∫•t file HTML th√†nh c√¥ng!');
};

// --- G√ÅN S·ª∞ KI·ªÜN ---
addRowBtn.onclick = () => addKpiRow();
saveKpiBtn.onclick = () => saveKpiData();
backToListBtn.onclick = () => { hideForm(); openModal(); };
addNewKpiFromModalBtn.onclick = resetMainFormAndShow;
closeModalBtn.onclick = closeModal;

// --- KH·ªûI T·∫†O KHI T·∫¢I TRANG ---
document.addEventListener('DOMContentLoaded', () => {
    // Kh·ªüi t·∫°o editors
    try {
        initEditors();
    } catch (e) {
        console.error('L·ªói kh·ªüi t·∫°o editor:', e);
    }
    
    // Th√™m s·ª± ki·ªán input
    addEvaluationInputEvents();
    
    // Th√™m 1 h√†ng m·∫∑c ƒë·ªãnh
    addKpiRow();
    
    // T√≠nh ƒëi·ªÉm ban ƒë·∫ßu
    calcTotalEvaluationScore();
    
    // ƒê·∫∑t ng√†y m·∫∑c ƒë·ªãnh
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    document.getElementById('creationDate').value = formattedDate;
    
    // Hi·ªÉn th·ªã modal danh s√°ch
    openModal();
});

// Th√™m s·ª± ki·ªán ƒë·ªÉ ƒë√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    if (event.target == kpiListModal) {
        closeModal();
    }
}
</script>
</body>
</html>
