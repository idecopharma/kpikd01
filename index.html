<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BẢNG KPI KINH DOANH - IDECO (Bản hoàn chỉnh)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- QuillJS Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; }
        .table-container { overflow-x: auto; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; vertical-align: top; }
        th { background: #4f46e5; color: white; position: sticky; top: 0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background:rgba(0,0,0,0.5);}
        .modal-content { background: #fff; margin: 10% auto; padding: 24px; border-radius: 8px; width: 90%; max-width: 600px;}
        .action-button { background: #4f46e5; color: white; padding: 10px 18px; border-radius: 6px; font-weight: 500; border:none; cursor:pointer; }
        .action-button:hover { background: #4338ca; }
        .danger-button { background: #ef4444; }
        .danger-button:hover { background: #dc2626; }
        .secondary-button { background: #6b7280; }
        .secondary-button:hover { background: #4b5563; }
        .framed-info { border: 2px solid #6366f1; border-radius: 14px; background: #f5f3ff; box-shadow: 0 1px 8px #d1d5db33; }
        .quill-editor {
            min-height: 90px;
            resize: vertical;
            overflow: auto;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 100%;
            margin-bottom: 16px;
        }
        .ql-toolbar.ql-snow { border-radius: 8px 8px 0 0; }
        .ql-container.ql-snow { border-radius: 0 0 8px 8px; }
        .score-input { width: 80px; text-align: center; }
        .kpi-score-display { font-weight: bold; color: #dc2626; }
        .total-score-box { 
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- FORM KPI -->
    <div class="container mx-auto bg-white p-6 md:p-8 rounded-lg shadow-xl" id="mainKpiForm" style="display: none;">
        <h1 class="text-3xl font-bold text-center mb-8 text-indigo-700">BẢNG KPI KINH DOANH - BÁO CÁO CÔNG VIỆC VÀ CHỈ SỐ KPI CUỐI KỲ THÁNG</h1>
        
        <!-- THÔNG TIN NGƯỜI LẬP -->
        <div class="framed-info p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label for="creatorName" class="block text-sm font-medium text-gray-700 mb-1">Tên người lập:</label>
                <input type="text" id="creatorName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Bộ phận:</label>
                <input type="text" id="department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
            <div>
                <label for="creationDate" class="block text-sm font-medium text-gray-700 mb-1">Ngày lập:</label>
                <input type="date" id="creationDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            </div>
        </div>

        <!-- TỔNG ĐIỂM KPI TỔNG HỢP -->
        <div class="total-score-box mb-8">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="text-center">
                    <div class="text-sm opacity-90">Bảng 1</div>
                    <div class="text-2xl font-bold" id="finalTable1Score">0</div>
                </div>
                <div class="text-center">
                    <div class="text-sm opacity-90">Bảng 2</div>
                    <div class="text-2xl font-bold" id="finalTable2Score">0</div>
                </div>
                <div class="text-center">
                    <div class="text-sm opacity-90">Bảng 3</div>
                    <div class="text-2xl font-bold" id="finalTable3Score">0</div>
                </div>
                <div class="text-center">
                    <div class="text-sm opacity-90">Bảng 4</div>
                    <div class="text-2xl font-bold" id="finalTable4Score">0</div>
                </div>
                <div class="text-center border-l border-white/30 pl-4">
                    <div class="text-sm opacity-90">TỔNG ĐIỂM</div>
                    <div class="text-4xl font-bold" id="totalEvaluationScore">0</div>
                </div>
            </div>
        </div>

        <!-- BẢNG 1: KPI HOÀN THÀNH TRÁCH NHIỆM (ĐỘNG) -->
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">KPI HOÀN THÀNH TRÁCH NHIỆM GIAO TRONG KỲ THEO ĐỊNH HƯỚNG </h2>
        <div class="table-container mb-8 rounded-lg border border-gray-200">
            <table id="kpiTable1" class="min-w-full">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Chỉ số KPI</th>
                        <th>Đạt chỉ số</th>
                        <th>Điểm KPI %</th>
                        <th>Đánh giá điểm (0-100)</th>
                        <th>Báo cáo</th>
                        <th>Xóa</th>
                    </tr>
                </thead>
                <tbody id="kpiTable1Body"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-right font-bold">Tổng điểm bảng 1:</td>
                        <td id="table1TotalScore" class="kpi-score-display">0%</td>
                        <td id="table1TotalEvaluation" class="kpi-score-display">0</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <button id="addRowBtn" class="action-button mb-8">Thêm chỉ số KPI</button>

        <!-- BẢNG 2: KPI DOANH THU MỤC TIÊU (TĨNH) -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-indigo-300 shadow-md">
            <h2 class="text-2xl font-bold text-indigo-700 mb-6">KPI DOANH THU MỤC TIÊU - TĂNG TRƯỞNG DOANH THU TRONG KỲ</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable2" class="min-w-full">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Chỉ số KPI</th>
                            <th>Đạt chỉ số</th>
                            <th>Điểm KPI %</th>
                            <th>Đánh giá điểm (0-100)</th>
                            <th>Báo cáo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><b style="color: red;">A.1 Doanh thu tồng tối thiểu  trong tháng quy định</b></td>
                            <td>Đạt từ 100%</td>
                            <td class="kpi2-score kpi-score-display">10%</td>
                            <td><input class="kpi2-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                        
                        <tr>
                            <td>2</td>
                            <td>Tỉ lệ tổng doanh thu do bạn lập đơn kỳ này so với kỳ tháng trước ( không gồm trong chuỗi NT :Long Châu hay Pharmacity)</td>
                            <td>Đạt từ -5% đến 16%</td>
                            <td class="kpi2-score kpi-score-display">15%</td>
                            <td><input class="kpi2-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Tỉ lệ tổng doanh thu do bạn lập đơn kỳ này so với kỳ tháng trước ( không gồm trong chuỗi NT :Long Châu hay Pharmacity) </td>
                            <td>Đạt từ 17% đến 35%</td>
                            <td class="kpi2-score kpi-score-display">25%</td>
                            <td><input class="kpi2-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Tỉ lệ tổng doanh thu do nhân viên lập đơn hàng kỳ này so kỳ trước (không gồm chuỗi NT:Long Châu, Pharmacity) </td>
                            <td>Từ 36% trở lên</td>
                            <td class="kpi2-score kpi-score-display" style="color:red;font-weight:bold;">40%</td>
                            <td><input class="kpi2-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>Tỉ lệ tổng doanh thu chuỗi NT được giao quản lý kỳ so kỳ trước hoàn thành tốt giao hàng </td>
                            <td> Tăng trưởng từ 15% </td>
                            <td class="kpi2-score kpi-score-display" style="color:red;font-weight:bold;">10%</td>
                            <td><input class="kpi2-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-right font-bold">Tổng điểm KPI bảng 2:</td>
                            <td id="table2TotalScore" class="kpi-score-display">80%</td>
                            <td id="table2TotalEvaluation" class="kpi-score-display">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <!-- Editor BẢNG 2 -->
            <div class="kpi2-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Phân tích báo cáo cuối kỳ:</label>
                <div id="kpi2NoteEditor" class="quill-editor"></div>
            </div>
        </div>
        <!-- END BẢNG 2 -->

        <!-- BẢNG 3: KPI XÚC TIẾN KHÁCH HÀNG (TĨNH) -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-green-300 shadow-md">
            <h2 class="text-2xl font-bold text-green-700 mb-6">KPI XÚC TIẾN KHÁCH HÀNG THÀNH CÔNG CÓ ĐƠN (GỒM KHÁCH HÀNG GIAO + KHÁCH HÀNG MỚI/KỲ)</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable3" class="min-w-full">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Chỉ số KPI</th>
                            <th>Đạt chỉ số</th>
                            <th>Điểm KPI %</th>
                            <th>Đánh giá điểm (0-100)</th>
                            <th>Báo cáo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Số khách hàng do nhân viên lập - hoàn thành chốt đơn trong kỳ thành công</td>
                            <td>Đạt tử 12 khách hàng/kỳ</td>
                            <td class="kpi3-score kpi-score-display">5%</td>
                            <td><input class="kpi3-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi3-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Số khách hàng do nhân viên lập - hoàn thành chốt đơn trong kỳ thành công</td>
                            <td>Đạt từ 18 khách hàng/kỳ đến 25 khách hàng/kỳ</td>
                            <td class="kpi3-score kpi-score-display">10%</td>
                            <td><input class="kpi3-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi3-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                            <td>3</td>
                            <td>Số khách hàng do nhân viên lập - hoàn thành chốt đơn trong kỳ thành công</td>
                            <td>Trên 26 khách hàng/kỳ</td>
                            <td class="kpi3-score kpi-score-display">15%</td>
                            <td><input class="kpi3-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi3-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-right font-bold">Tổng điểm KPI bảng 3:</td>
                            <td id="table3TotalScore" class="kpi-score-display">60%</td>
                            <td id="table3TotalEvaluation" class="kpi-score-display">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <!-- Editor BẢNG 3 -->
            <div class="kpi3-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Phân tích báo cáo cuối kỳ:</label>
                <div id="kpi3NoteEditor" class="quill-editor"></div>
            </div>
        </div>
        <!-- END BẢNG 3 -->

        <!-- BẢNG 4: KPI GHI NHẬN NỖ LỰC VƯỢT TRỘI (TĨNH) -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-blue-300 shadow-md">
            <h2 class="text-2xl font-bold text-blue-700 mb-6">KPI GHI NHẬN NỖ LỰC VƯỢT TRỘI CHO NHÓM DƯỢC MỸ PHẨM UVS</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable4" class="min-w-full">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Chỉ số KPI</th>
                            <th>Đạt chỉ số</th>
                            <th>Điểm KPI %</th>
                            <th>Đánh giá điểm (0-100)</th>
                            <th>Báo cáo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><b style="color:green;">Doanh thu nhóm không phải thuốc kỳ so kỳ trước </b></td>
                            <td>Từ - 5%  đến 10%</td>
                            <td class="kpi4-score kpi-score-display">5%</td>
                            <td><input class="kpi4-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td><b style="color:green;">Doanh thu nhóm không phải thuốc kỳ này so ký trước</b></td>
                            <td> Từ 11% </td>
                            <td class="kpi4-score kpi-score-display" style="color:red;font-weight:bold;">25%</td>
                            <td><input class="kpi4-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                    <tr>
                            <td>3</td>
                            <td><b style="color:green;">Phát triển thành công khách hàng mới đặt nhóm không phải thuốc trong kỳ</b></td>
                            <td> Từ 2 khách hàng/ thàng  </td>
                            <td class="kpi4-score kpi-score-display" style="color:red;font-weight:bold;">30%</td>
                            <td><input class="kpi4-evaluation score-input border rounded-md p-2" type="number" min="0" max="100" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-2" rows="2">Em tự đánh giá</textarea></td>
                        </tr>
                    
                    
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-right font-bold">Tổng điểm KPI bảng 4:</td>
                            <td id="table4TotalScore" class="kpi-score-display">30%</td>
                            <td id="table4TotalEvaluation" class="kpi-score-display">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="kpi4-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Phân tích báo cáo cuối kỳ:</label>
                <div id="kpi4NoteEditor" class="quill-editor"></div>
            </div>
        </div>
        <!-- END BẢNG 4 -->

        <!-- PHẦN XÁC NHẬN VÀ PHÊ DUYỆT -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-gray-300 shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">XÁC NHẬN VÀ PHÊ DUYỆT</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Người được đánh giá -->
                <div class="border border-gray-300 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-blue-700 mb-4">XÁC NHẬN CỦA NGƯỜI ĐƯỢC ĐÁNH GIÁ</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="employeeName" class="block text-sm font-medium text-gray-700 mb-1">Họ và tên:</label>
                            <input type="text" id="employeeName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="employeeDate" class="block text-sm font-medium text-gray-700 mb-1">Ngày ký:</label>
                            <input type="date" id="employeeDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Quản lý phê duyệt -->
                <div class="border border-gray-300 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-green-700 mb-4">PHÊ DUYỆT CỦA QUẢN LÝ</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="managerName" class="block text-sm font-medium text-gray-700 mb-1">Họ và tên:</label>
                            <input type="text" id="managerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                        <div>
                            <label for="managerPosition" class="block text-sm font-medium text-gray-700 mb-1">Chức vụ:</label>
                            <input type="text" id="managerPosition" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                        <div>
                            <label for="managerDate" class="block text-sm font-medium text-gray-700 mb-1">Ngày phê duyệt:</label>
                            <input type="date" id="managerDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUY ĐỊNH THƯỞNG KPI -->
        <div class="mt-4 p-6 border border-dashed border-green-500 bg-green-50 rounded-xl shadow-sm mb-8">
            <div class="font-semibold mb-4 text-green-700 text-lg">QUY ĐỊNH THƯỞNG KPI - TÍNH THƯỞNG HOA HỒNG</div>
            <div class="text-gray-700 leading-relaxed">
                <!-- Nội dung quy định thưởng giữ nguyên -->
                <p><b>ĐIỂM KPI TĂNG SẼ TĂNG THU NHẬP TÍNH ĐIỂM KPI - KPI CÓ THỂ HƠN 100% ĐIỂM CHUẨN</b></p><br>
                <p><b>1. Nhóm Thuốc:</b></p>
                <p>- Thành công 1 Nhà thuốc cho thuốc có tổng giá trị đặt hàng tối thiểu <b style="color: #e74c3c;"> từ 3 triệu đồng</b> - thưởng <b style="color: #e74c3c;">200,000 đồng/nhà thuốc</b>.</p>
                <p>- Giới thiệu 1 sản phẩm THUỐC mới vào khách hàng đang hợp tác chốt thành công có đơn hàng từ <b style="color: #e74c3c;"> từ 1 triệu đồng</b> - thưởng <b style="color: #e74c3c;">100,000 đồng/1 sản phẩm</b>.</p>
                <p><b>2. Nhóm Không Thuốc:</b></p>
                <p>- Thành công 1 Nhà thuốc cho nhóm không thuốc có tổng giá trị đặt hàng từ <b style="color: #e74c3c;">3 triệu đồng</b> - thưởng <b style="color: #e74c3c;">400,000 đồng/nhà thuốc</b>.</p>
                <p>- Giới thiệu 1 sản phẩm UVS mới vào khách hàng đang hợp tác chốt thành công có đơn hàng từ <b style="color: #e74c3c;"> từ 1 triệu đồng</b> - thưởng <b style="color: #e74c3c;">200,000 đồng/1 sản phẩm</b>.</p>
                <p><b>3. Nhà Phân Phối (NPP):</b></p>
                <p>- Thành công 1 NPP cho nhóm không thuốc có tổng giá trị đặt hàng từ <b style="color: #e74c3c;"> từ 8 triệu đồng/đơn</b> - thưởng <b style="color: #e74c3c;">1 triệu đồng/nhà thuốc</b>.</p>
                <p>- Giới thiệu 1 sản phẩm mới UVS hay Thuốc vào hợp tác với NPP hiện tại đang hợp tác thành công - thưởng <b style="color: #e74c3c;">300,000 đồng/1 sản phẩm</b>.</p>
                <p><b>4. Mở Rộng Thị Trường:</b></p>
                <p>- Mở chuỗi Nhà Thuốc mới có lên đơn tối thiểu <b style="color: #e74c3c;">5 triệu đồng</b> - thưởng <b style="color: #e74c3c;">800,000 đồng</b>.</p>
                <p>- Mở thành công NT trong phòng khám - có đặt hàng có giá trị tối thiểu <b style="color: #e74c3c;"> từ 6 triệu đồng</b> - thưởng <b style="color: #e74c3c;">800,000 đồng/khách hàng</b>.</p>
                <p><b>QUY ĐỊNH CHUNG:</b></p>
                <ul>
                    <li>a. Cho phép cộng dồn 2 đơn hàng trong thời gian tối đa <b style="color: #e74c3c;">20 ngày</b> để có tổng giá trị đơn đạt mức thưởng trên và trả tại thời điểm đơn cuối.</li>
                    <li>b. Khi tính thưởng giới thiệu thành công sản phẩm mới vào khách hàng hiện tại, phải báo cáo khai báo trên Giao dịch ERP, báo cáo rõ cuối kỳ và trước kỳ lương để nhận thưởng.</li>
                    <li>c. Công ty tính thưởng trên báo cáo cuối kỳ của nhân viên đúng theo quy định và có xác nhận từ bộ phận kế toán - cấp quản lý kinh doanh.</li>
                    <li>d. Đối với 1 Nhà thuốc có cùng tư cách pháp nhân khi mở chi nhánh mới thì chi nhánh mới không được tính là mở 1 nhà thuốc mới vì đã được tính vào doanh thu đặt hàng chung.</li>
                    <li>e. <b>GHI CHÚ: DOANH THU TÍNH TỈ LỆ TĂNG TRƯỞNG Ở MỤC KPI: LÀ DOANH THU GỘP (GỒM CẢ CÔNG NỢ)</b></li>
                    <li>f. <b>GHI CHÚ: NHÂN VIÊN KINH DOANH PHẢI BÁO CÁO CÁC CHỈ SỐ KPI TRÊN TRONG BÁO CÁO CUỐI THÁNG MỚI NHẬN THƯỞNG KPI KHI XEM XÉT ĐÁNH GIÁ</b></li>
                </ul>
                <p><b>HOA HỒNG ĐƯỢC TÍNH CHO KHÁCH HÀNG DO NHÂN VIÊN KHAI THÁC TRỰC TIẾP VÀ TÍNH LŨY KẾ DOANH THU TẠI THỜI ĐIỂM TRONG KỲ THÁNG</b></p><br>
                <p><b>a. Doanh Thu nhóm không phải thuốc:</b><br>
                - Doanh thu theo đơn hàng từ <b style="color: #e74c3c;">2.5 triệu đồng</b> - hoa hồng <b style="color: #e74c3c;">2%</b><br>
                - Doanh thu theo đơn hàng từ <b style="color: #e74c3c;">16 triệu đồng</b> - hoa hồng <b style="color: #e74c3c;">3.5%</b><br>
                - Doanh thu theo đơn hàng từ <b style="color: #e74c3c;">30 triệu đồng</b> - hoa hồng <b style="color: #e74c3c;">4.5%</b><br>
                - Doanh thu theo đơn hàng từ <b style="color: #e74c3c;">70 triệu đồng</b> - hoa hồng <b style="color: #e74c3c;">6%</b><br>
                </p>
                <p><b>b. Doanh thu nhóm thuốc:</b><br>
                - Doanh thu theo đơn hàng từ <b style="color: #e74c3c;">2.5 triệu đồng</b> - hoa hồng <b style="color: #e74c3c;">1.5%</b><br>
                - Doanh thu theo đơn hàng từ <b style="color: #e74c3c;">30 triệu đồng</b> - hoa hồng <b style="color: #e74c3c;">2%</b><br>
                - Doanh thu theo đơn hàng từ <b style="color: #e74c3c;">70 triệu đồng</b> - hoa hồng <b style="color: #e74c3c;">3%</b>
                </p>
                <p><u>Ghi chú:</u> doanh thu tính trên người lập đơn trên ERP và báo cáo cuối tháng để làm căn cứ tính.</p><br>
                <p><b>QUY ĐỊNH TRỪ ĐIỂM KPI:</b></p>
                <p><b>1.</b> Lỗi nhắc nhở sai sót khai báo giao dịch khách hàng - không thực hiện khai báo đúng khi phát triển khách hàng mới - <b style="color: #c0392b;">Trừ 5% điểm KPI/ lỗi nhắc/ 1 lần</b>.</p>
                <p><b>2.</b> Lỗi sai sót đơn hàng: chiết khấu- sản lượng làm ảnh hưởng đến thay đổi lại dữ liệu khách hàng trên ERP <b style="color: #c0392b;">Trừ 8% điểm KPI/lỗi/lần</b>.</p>
                <p><b>3.</b> Lỗi báo cáo Cuối Tháng theo quy định trễ không báo cáo theo quy định hay bị buộc phải làm lại do sai sót nhiều - <b style="color: #c0392b;">Trừ 10% điểm KPI</b>.</p>
                <p><b>6.</b> Lỗi không tuân thủ quy định -quy trịnh bộ phận kinh doanh, không làm đủ thủ tục giao dịch khách hàng theo quy định - <b style="color: #c0392b;">Trừ 8% điểm KPI/1 lần nhắc</b>.</p>
            </div>
        </div>

        <!-- NÚT HÀNH ĐỘNG -->
        <div class="flex flex-wrap gap-4 justify-center md:justify-start">
            <button id="saveKpiBtn" class="action-button">Lưu lại</button>
            <button id="exportPdfBtn" class="action-button secondary-button">Xuất file PDF</button>
            <button id="exportHtmlBtn" class="action-button secondary-button">Xuất file HTML</button>
            <button id="backToListBtn" class="action-button secondary-button">Quay lại Danh sách</button>
        </div>
    </div>

    <!-- MODAL DANH SÁCH KPI -->
    <div id="kpiListModal" class="modal">
        <div class="modal-content">
            <span class="float-right text-2xl cursor-pointer hover:text-gray-700" id="closeModalBtn">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">KPI PHỤ TRÁCH ĐIỀU PHỐI - PHÁT TRIỂN KINH DOANH</h2>
            <button id="addNewKpiFromModalBtn" class="action-button mb-4 w-full">Thêm mới Bảng KPI</button>
            <a href="https://erp-ideco.skyit.vn/#/app/dashboard/main" target="_blank" class="secondary-button mb-6 w-full text-center block py-2 rounded-md">ERP HOME</a>
            <div class="text-sm text-gray-500 mb-3">Danh sách KPI đã lưu:</div>
            <div id="savedKpiList" class="space-y-3 max-h-96 overflow-y-auto p-2"></div>
        </div>
    </div>

<script>
// ========== FIREBASE CONFIG ==========
const firebaseConfig = {
    apiKey: "AIzaSyDa84ErhJfqyirTNNeLkZEuVz--q6IK5TQ",
    authDomain: "kpikdchuyenvien.firebaseapp.com",
    projectId: "kpikdchuyenvien",
    storageBucket: "kpikdchuyenvien.firebasestorage.app",
    messagingSenderId: "520992882938",
    appId: "1:520992882938:web:ea9842cbd2cb1b5f340943",
    measurementId: "G-HJ7X958PLV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ========== BIẾN TOÀN CỤC ==========
const mainKpiForm = document.getElementById('mainKpiForm');
const kpiTable1Body = document.getElementById('kpiTable1Body');
const addRowBtn = document.getElementById('addRowBtn');
const saveKpiBtn = document.getElementById('saveKpiBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const exportHtmlBtn = document.getElementById('exportHtmlBtn');
const backToListBtn = document.getElementById('backToListBtn');
const kpiListModal = document.getElementById('kpiListModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const savedKpiListDiv = document.getElementById('savedKpiList');
const addNewKpiFromModalBtn = document.getElementById('addNewKpiFromModalBtn');
let currentKpiId = null;
let rowCounter = 0;

// ========== QUILL EDITORS ==========
const quillToolbar = [
    ['bold', 'italic', 'underline', 'strike'],
    [{ 'font': [] }],
    [{ 'size': ['small', false, 'large', 'huge'] }],
    [{ 'align': [] }],
    [{ 'color': [] }, { 'background': [] }],
    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
    ['clean']
];

let kpi2NoteEditor, kpi3NoteEditor, kpi4NoteEditor;

function initEditors() {
    kpi2NoteEditor = new Quill('#kpi2NoteEditor', {
        modules: { toolbar: quillToolbar },
        theme: 'snow'
    });
    kpi3NoteEditor = new Quill('#kpi3NoteEditor', {
        modules: { toolbar: quillToolbar },
        theme: 'snow'
    });
    kpi4NoteEditor = new Quill('#kpi4NoteEditor', {
        modules: { toolbar: quillToolbar },
        theme: 'snow'
    });
}

function resetEditors() {
    kpi2NoteEditor.root.innerHTML = '';
    kpi3NoteEditor.root.innerHTML = '';
    kpi4NoteEditor.root.innerHTML = '';
}

// ========== HÀM TIỆN ÍCH ==========
function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9) + Date.now();
}

function showForm() { 
    mainKpiForm.style.display = 'block'; 
}

function hideForm() { 
    mainKpiForm.style.display = 'none'; 
}

function openModal() { 
    displaySavedKpis(); 
    kpiListModal.style.display = 'block'; 
}

function closeModal() { 
    kpiListModal.style.display = 'none'; 
}

// ========== THÊM HÀNG VÀO BẢNG 1 (ĐỘNG) ==========
function addKpiRow(data = {}) {
    rowCounter++;
    const row = kpiTable1Body.insertRow();
    row.innerHTML = `
        <td class="text-center font-bold">${rowCounter}</td>
        <td><textarea class="kpiIndicator w-full p-2 border rounded-md" placeholder="Mô tả chỉ số KPI">${data.kpiIndicator||''}</textarea></td>
        <td><input type="text" class="achievedIndicator w-full p-2 border rounded-md" value="${data.achievedIndicator||''}" placeholder="Chỉ số đạt được"></td>
        <td><input type="number" class="kpiScore score-input border rounded-md p-2" value="${data.kpiScore||''}" placeholder="%" min="0" max="100"></td>
        <td><input type="number" min="0" max="100" class="scoreEvaluation score-input border rounded-md p-2" value="${data.scoreEvaluation||'0'}" placeholder="Điểm"></td>
        <td><textarea class="reportNotes w-full p-2 border rounded-md" rows="2" placeholder="Báo cáo chi tiết">${data.reportNotes||''}</textarea></td>
        <td class="text-center"><button class="deleteRowBtn danger-button text-xs px-3 py-1 rounded">Xóa</button></td>
    `;
    
    // Xử lý sự kiện xóa hàng
    row.querySelector('.deleteRowBtn').onclick = () => {
        row.remove();
        updateRowNumbers();
        calculateAllScores();
    };
    
    // Xử lý sự kiện tính điểm
    const scoreInput = row.querySelector('.scoreEvaluation');
    scoreInput.addEventListener('input', calculateAllScores);
    
    return row;
}

// Cập nhật số thứ tự
function updateRowNumbers() {
    const rows = kpiTable1Body.querySelectorAll('tr');
    rowCounter = 0;
    rows.forEach((row, index) => {
        rowCounter++;
        row.cells[0].textContent = rowCounter;
    });
}

// ========== TÍNH ĐIỂM TỔNG HỢP ==========
function calculateAllScores() {
    let table1TotalScore = 0;
    let table1TotalEvaluation = 0;
    
    // === BẢNG 1 (động) ===
    const table1Rows = kpiTable1Body.querySelectorAll('tr');
    table1Rows.forEach(row => {
        const kpiScoreElem = row.querySelector('.kpiScore');
        const scoreEvaluationElem = row.querySelector('.scoreEvaluation');
        
        if (kpiScoreElem && scoreEvaluationElem) {
            const kpiScore = parseFloat(kpiScoreElem.value) || 0;
            const evaluation = parseFloat(scoreEvaluationElem.value) || 0;
            
            table1TotalScore += kpiScore;
            table1TotalEvaluation += evaluation;
        }
    });
    
    // === BẢNG 2 (tĩnh) ===
    let table2TotalEvaluation = 0;
    let table2TotalScore = 0;
    document.querySelectorAll('#kpiTable2 tbody tr').forEach((row, index) => {
        const kpiScoreElem = row.querySelector('.kpi2-score');
        const evaluationElem = row.querySelector('.kpi2-evaluation');
        
        if (kpiScoreElem && evaluationElem) {
            const kpiScoreText = kpiScoreElem.textContent.replace('%', '').trim();
            const kpiScore = parseFloat(kpiScoreText) || 0;
            const evaluation = parseFloat(evaluationElem.value) || 0;
            
            table2TotalScore += kpiScore;
            table2TotalEvaluation += evaluation;
        }
    });
    
    // === BẢNG 3 (tĩnh) ===
    let table3TotalEvaluation = 0;
    let table3TotalScore = 0;
    document.querySelectorAll('#kpiTable3 tbody tr').forEach((row, index) => {
        const kpiScoreElem = row.querySelector('.kpi3-score');
        const evaluationElem = row.querySelector('.kpi3-evaluation');
        
        if (kpiScoreElem && evaluationElem) {
            const kpiScoreText = kpiScoreElem.textContent.replace('%', '').trim();
            const kpiScore = parseFloat(kpiScoreText) || 0;
            const evaluation = parseFloat(evaluationElem.value) || 0;
            
            table3TotalScore += kpiScore;
            table3TotalEvaluation += evaluation;
        }
    });
    
    // === BẢNG 4 (tĩnh) ===
    let table4TotalEvaluation = 0;
    let table4TotalScore = 0;
    document.querySelectorAll('#kpiTable4 tbody tr').forEach((row, index) => {
        const kpiScoreElem = row.querySelector('.kpi4-score');
        const evaluationElem = row.querySelector('.kpi4-evaluation');
        
        if (kpiScoreElem && evaluationElem) {
            const kpiScoreText = kpiScoreElem.textContent.replace('%', '').trim();
            const kpiScore = parseFloat(kpiScoreText) || 0;
            const evaluation = parseFloat(evaluationElem.value) || 0;
            
            table4TotalScore += kpiScore;
            table4TotalEvaluation += evaluation;
        }
    });
    
    // Tính tổng điểm đánh giá
    const totalEvaluationScore = table1TotalEvaluation + table2TotalEvaluation + table3TotalEvaluation + table4TotalEvaluation;
    
    // Cập nhật hiển thị tổng từng bảng
    document.getElementById('table1TotalScore').textContent = table1TotalScore + '%';
    document.getElementById('table1TotalEvaluation').textContent = table1TotalEvaluation;
    
    document.getElementById('table2TotalEvaluation').textContent = table2TotalEvaluation;
    
    document.getElementById('table3TotalEvaluation').textContent = table3TotalEvaluation;
    
    document.getElementById('table4TotalEvaluation').textContent = table4TotalEvaluation;
    
    // Cập nhật tổng điểm trong box
    document.getElementById('finalTable1Score').textContent = table1TotalEvaluation;
    document.getElementById('finalTable2Score').textContent = table2TotalEvaluation;
    document.getElementById('finalTable3Score').textContent = table3TotalEvaluation;
    document.getElementById('finalTable4Score').textContent = table4TotalEvaluation;
    document.getElementById('totalEvaluationScore').textContent = totalEvaluationScore;
    
    return {
        table1: { score: table1TotalScore, evaluation: table1TotalEvaluation },
        table2: { score: table2TotalScore, evaluation: table2TotalEvaluation },
        table3: { score: table3TotalScore, evaluation: table3TotalEvaluation },
        table4: { score: table4TotalScore, evaluation: table4TotalEvaluation },
        total: totalEvaluationScore
    };
}

// ========== LƯU DỮ LIỆU KPI ==========
function saveKpiData() {
    const creatorName = document.getElementById('creatorName').value.trim();
    const department = document.getElementById('department').value.trim();
    const creationDate = document.getElementById('creationDate').value;
    
    // Lấy dữ liệu xác nhận
    const employeeName = document.getElementById('employeeName').value.trim();
    const employeeDate = document.getElementById('employeeDate').value;
    const managerName = document.getElementById('managerName').value.trim();
    const managerPosition = document.getElementById('managerPosition').value.trim();
    const managerDate = document.getElementById('managerDate').value;
    
    if (!creatorName || !department || !creationDate) {
        alert('Vui lòng nhập đầy đủ Tên người lập, Bộ phận và Ngày lập.');
        return false;
    }
    
    // Thu thập dữ liệu bảng 1
    const kpiRowsData = [];
    const rows = kpiTable1Body.querySelectorAll('tr');
    rows.forEach(row => {
        const kpiIndicator = row.querySelector('.kpiIndicator');
        if (kpiIndicator && kpiIndicator.value.trim()) {
            kpiRowsData.push({
                kpiIndicator: kpiIndicator.value.trim(),
                achievedIndicator: row.querySelector('.achievedIndicator').value.trim(),
                kpiScore: row.querySelector('.kpiScore').value,
                scoreEvaluation: row.querySelector('.scoreEvaluation').value,
                reportNotes: row.querySelector('.reportNotes').value.trim(),
            });
        }
    });
    
    // Thu thập dữ liệu bảng 2
    const kpi2Data = [];
    document.querySelectorAll('#kpiTable2 tbody tr').forEach((row, index) => {
        kpi2Data.push({
            evaluation: row.querySelector('.kpi2-evaluation').value,
            report: row.querySelector('.kpi2-report').value
        });
    });
    
    // Thu thập dữ liệu bảng 3
    const kpi3Data = [];
    document.querySelectorAll('#kpiTable3 tbody tr').forEach((row, index) => {
        kpi3Data.push({
            evaluation: row.querySelector('.kpi3-evaluation').value,
            report: row.querySelector('.kpi3-report').value
        });
    });
    
    // Thu thập dữ liệu bảng 4
    const kpi4Data = [];
    document.querySelectorAll('#kpiTable4 tbody tr').forEach((row, index) => {
        kpi4Data.push({
            evaluation: row.querySelector('.kpi4-evaluation').value,
            report: row.querySelector('.kpi4-report').value
        });
    });
    
    // Lấy nội dung editor
    const kpi2Note = kpi2NoteEditor.root.innerHTML;
    const kpi3Note = kpi3NoteEditor.root.innerHTML;
    const kpi4Note = kpi4NoteEditor.root.innerHTML;
    
    // Tính tổng điểm
    const scores = calculateAllScores();
    
    // Tạo đối tượng dữ liệu
    const kpiData = {
        creatorName,
        department,
        creationDate,
        employeeName,
        employeeDate,
        managerName,
        managerPosition,
        managerDate,
        kpiRows: kpiRowsData,
        kpi2Data,
        kpi3Data,
        kpi4Data,
        kpi2Note,
        kpi3Note,
        kpi4Note,
        scores,
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
        id: currentKpiId || generateId(),
        lastModified: new Date().toISOString()
    };
    
    // Lưu lên Firebase
    db.ref('kpiBoards_kd/' + kpiData.id).set(kpiData, err => {
        if (err) {
            alert('Lỗi khi lưu lên server: ' + err.message);
        } else {
            alert('Đã lưu bảng KPI thành công!');
            currentKpiId = kpiData.id;
            displaySavedKpis();
        }
    });
    
    return true;
}

// ========== HIỂN THỊ DANH SÁCH KPI ĐÃ LƯU ==========
function displaySavedKpis() {
    savedKpiListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Đang tải dữ liệu...</p>';
    
    db.ref('kpiBoards_kd').once('value', snapshot => {
        const kpisObj = snapshot.val() || {};
        const kpis = Object.values(kpisObj);
        
        savedKpiListDiv.innerHTML = '';
        
        if (kpis.length === 0) {
            savedKpiListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Chưa có bảng KPI nào được lưu.</p>';
            return;
        }
        
        // Sắp xếp theo ngày mới nhất
        kpis.sort((a, b) => new Date(b.creationDate) - new Date(a.creationDate));
        
        kpis.forEach(kpi => {
            const div = document.createElement('div');
            div.className = 'kpi-list-item p-4 border rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer bg-white';
            
            const totalScore = kpi.scores ? kpi.scores.total : 0;
            
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-grow">
                        <p class="font-semibold text-indigo-700">${kpi.creatorName}</p>
                        <p class="text-sm text-gray-600">${kpi.department} • ${kpi.creationDate}</p>
                        <p class="text-xs text-gray-500 mt-1">${kpi.kpiRows ? kpi.kpiRows.length : 0} chỉ số • ID: ${kpi.id.substring(0, 8)}...</p>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg ${totalScore >= 80 ? 'text-green-600' : totalScore >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                            ${totalScore} điểm
                        </div>
                        <button class="deleteSavedKpiBtn danger-button text-xs px-2 py-1 mt-2 rounded" data-id="${kpi.id}">Xóa</button>
                    </div>
                </div>
            `;
            
            // Click để mở KPI
            div.querySelector('.flex-grow').onclick = () => loadKpiToForm(kpi.id);
            
            // Nút xóa
            div.querySelector('.deleteSavedKpiBtn').onclick = e => {
                e.stopPropagation();
                const password = prompt('Vui lòng nhập mật khẩu để xác nhận xóa:');
                if (password !== 'minhtriet1973') {
                    alert('Sai mật khẩu! Không được xóa.');
                    return;
                }
                if (confirm('Bạn có chắc chắn muốn xóa bảng KPI này?')) {
                    deleteKpi(kpi.id);
                }
            };
            
            savedKpiListDiv.appendChild(div);
        });
    });
}

// ========== TẢI KPI VÀO FORM ==========
function loadKpiToForm(kpiId) {
    db.ref('kpiBoards_kd/' + kpiId).once('value', snap => {
        const kpi = snap.val();
        if (kpi) {
            currentKpiId = kpiId;
            
            // Điền thông tin cơ bản
            document.getElementById('creatorName').value = kpi.creatorName;
            document.getElementById('department').value = kpi.department;
            document.getElementById('creationDate').value = kpi.creationDate;
            
            // Điền thông tin xác nhận
            document.getElementById('employeeName').value = kpi.employeeName || '';
            document.getElementById('employeeDate').value = kpi.employeeDate || '';
            document.getElementById('managerName').value = kpi.managerName || '';
            document.getElementById('managerPosition').value = kpi.managerPosition || '';
            document.getElementById('managerDate').value = kpi.managerDate || '';
            
            // Tải bảng 1
            kpiTable1Body.innerHTML = '';
            rowCounter = 0;
            (kpi.kpiRows || []).forEach(r => addKpiRow(r));
            if ((kpi.kpiRows || []).length === 0) addKpiRow();
            
            // Tải bảng 2
            if (kpi.kpi2Data) {
                document.querySelectorAll('#kpiTable2 .kpi2-evaluation').forEach((input, index) => {
                    if (kpi.kpi2Data[index]) input.value = kpi.kpi2Data[index].evaluation;
                });
                document.querySelectorAll('#kpiTable2 .kpi2-report').forEach((textarea, index) => {
                    if (kpi.kpi2Data[index]) textarea.value = kpi.kpi2Data[index].report;
                });
            }
            
            // Tải bảng 3
            if (kpi.kpi3Data) {
                document.querySelectorAll('#kpiTable3 .kpi3-evaluation').forEach((input, index) => {
                    if (kpi.kpi3Data[index]) input.value = kpi.kpi3Data[index].evaluation;
                });
                document.querySelectorAll('#kpiTable3 .kpi3-report').forEach((textarea, index) => {
                    if (kpi.kpi3Data[index]) textarea.value = kpi.kpi3Data[index].report;
                });
            }
            
            // Tải bảng 4
            if (kpi.kpi4Data) {
                document.querySelectorAll('#kpiTable4 .kpi4-evaluation').forEach((input, index) => {
                    if (kpi.kpi4Data[index]) input.value = kpi.kpi4Data[index].evaluation;
                });
                document.querySelectorAll('#kpiTable4 .kpi4-report').forEach((textarea, index) => {
                    if (kpi.kpi4Data[index]) textarea.value = kpi.kpi4Data[index].report;
                });
            }
            
            // Tải nội dung editor
            kpi2NoteEditor.root.innerHTML = kpi.kpi2Note || '';
            kpi3NoteEditor.root.innerHTML = kpi.kpi3Note || '';
            kpi4NoteEditor.root.innerHTML = kpi.kpi4Note || '';
            
            // Hiển thị form
            showForm();
            closeModal();
            
            // Tính toán lại điểm
            calculateAllScores();
        }
    });
}

// ========== XÓA KPI ==========
function deleteKpi(kpiIdToDelete) {
    db.ref('kpiBoards_kd/' + kpiIdToDelete).remove().then(() => {
        displaySavedKpis();
        if (currentKpiId === kpiIdToDelete) {
            currentKpiId = null;
            resetMainForm();
        }
    });
}

// ========== RESET FORM ==========
function resetMainForm() {
    document.getElementById('creatorName').value = '';
    document.getElementById('department').value = '';
    document.getElementById('creationDate').valueAsDate = new Date();
    
    // Reset phần xác nhận
    document.getElementById('employeeName').value = '';
    document.getElementById('employeeDate').value = '';
    document.getElementById('managerName').value = '';
    document.getElementById('managerPosition').value = '';
    document.getElementById('managerDate').valueAsDate = new Date();
    
    kpiTable1Body.innerHTML = '';
    rowCounter = 0;
    addKpiRow();
    
    resetEditors();
    
    // Reset bảng 2
    document.querySelectorAll('#kpiTable2 .kpi2-evaluation').forEach(input => input.value = '0');
    document.querySelectorAll('#kpiTable2 .kpi2-report').forEach(textarea => textarea.value = 'Em tự đánh giá');
    
    // Reset bảng 3
    document.querySelectorAll('#kpiTable3 .kpi3-evaluation').forEach(input => input.value = '0');
    document.querySelectorAll('#kpiTable3 .kpi3-report').forEach(textarea => textarea.value = 'Em tự đánh giá');
    
    // Reset bảng 4
    document.querySelectorAll('#kpiTable4 .kpi4-evaluation').forEach(input => input.value = '0');
    document.querySelectorAll('#kpiTable4 .kpi4-report').forEach(textarea => textarea.value = 'Em tự đánh giá');
    
    calculateAllScores();
}

// ========== XUẤT PDF ==========
exportPdfBtn.onclick = function() {
    const creatorName = document.getElementById('creatorName').value.trim();
    const department = document.getElementById('department').value.trim();
    const creationDate = document.getElementById('creationDate').value;
    
    if (!creatorName || !department || !creationDate) {
        alert('Vui lòng nhập đủ thông tin trước khi xuất PDF!');
        return;
    }
    
    // Ẩn các nút không cần thiết
    const buttonsToHide = ['exportPdfBtn', 'exportHtmlBtn', 'saveKpiBtn', 'backToListBtn', 'addRowBtn'];
    buttonsToHide.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.style.display = 'none';
    });
    
    const element = document.getElementById('mainKpiForm');
    const opt = {
        margin: [0.5, 0.5, 0.5, 0.5],
        filename: `KPI_${creatorName}_${department}_${creationDate}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };
    
    html2pdf().set(opt).from(element).save().then(() => {
        // Hiện lại nút
        buttonsToHide.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.style.display = '';
        });
    });
};

// ========== XUẤT HTML ==========
exportHtmlBtn.onclick = function() {
    const creatorName = document.getElementById('creatorName').value.trim();
    const department = document.getElementById('department').value.trim();
    const creationDate = document.getElementById('creationDate').value;
    
    // Lấy thông tin xác nhận
    const employeeName = document.getElementById('employeeName').value.trim();
    const employeeDate = document.getElementById('employeeDate').value;
    const managerName = document.getElementById('managerName').value.trim();
    const managerPosition = document.getElementById('managerPosition').value.trim();
    const managerDate = document.getElementById('managerDate').value;
    
    if (!creatorName || !department || !creationDate) {
        alert('Vui lòng nhập đủ thông tin trước khi xuất HTML!');
        return;
    }
    
    const scores = calculateAllScores();
    
    // Tạo HTML tĩnh
    const html = `
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BÁO CÁO KPI KINH DOANH - ${creatorName} - ${creationDate}</title>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .report-container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #4f46e5; }
        .header h1 { color: #4f46e5; margin: 0; }
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; padding: 20px; background: #f0f9ff; border-radius: 10px; }
        .info-item label { font-weight: bold; display: block; color: #555; margin-bottom: 5px; }
        .info-item span { font-size: 1.1em; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th { background: #4f46e5; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border: 1px solid #ddd; }
        tr:nth-child(even) { background: #f9f9f9; }
        .score-display { font-weight: bold; color: #dc2626; }
        .total-score { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; margin: 30px 0; }
        .total-score .label { font-size: 1.2em; opacity: 0.9; }
        .total-score .value { font-size: 3em; font-weight: bold; margin: 10px 0; }
        .section-title { color: #4f46e5; border-left: 5px solid #4f46e5; padding-left: 15px; margin: 25px 0 15px 0; }
        .regulation-box { background: #f0fff0; border: 2px dashed #22c55e; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .signature-box { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin: 20px 0; background: #f8f9fa; }
        .signature-box h3 { color: #4f46e5; margin-bottom: 15px; }
        .footer { text-align: center; margin-top: 40px; color: #888; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="report-container">
        <div class="header">
            <h1>BÁO CÁO KPI KINH DOANH</h1>
            <p>IDECO - Báo cáo cuối kỳ</p>
        </div>
        
        <div class="info-grid">
            <div class="info-item">
                <label>Người lập:</label>
                <span>${creatorName}</span>
            </div>
            <div class="info-item">
                <label>Bộ phận:</label>
                <span>${department}</span>
            </div>
            <div class="info-item">
                <label>Ngày lập:</label>
                <span>${creationDate}</span>
            </div>
        </div>
        
        <div class="total-score">
            <div class="label">TỔNG ĐIỂM ĐÁNH GIÁ KPI</div>
            <div class="value">${scores.total}</div>
            <div>Bảng 1: ${scores.table1.evaluation} điểm • Bảng 2: ${scores.table2.evaluation} điểm • Bảng 3: ${scores.table3.evaluation} điểm • Bảng 4: ${scores.table4.evaluation} điểm</div>
        </div>
        
        <h2 class="section-title">KPI HOÀN THÀNH TRÁCH NHIỆM</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Chỉ số KPI</th>
                    <th>Đạt chỉ số</th>
                    <th>Điểm KPI %</th>
                    <th>Đánh giá điểm</th>
                    <th>Báo cáo</th>
                </tr>
            </thead>
            <tbody>
                ${Array.from(kpiTable1Body.querySelectorAll('tr')).map((row, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${row.querySelector('.kpiIndicator').value || ''}</td>
                    <td>${row.querySelector('.achievedIndicator').value || ''}</td>
                    <td class="score-display">${row.querySelector('.kpiScore').value || '0'}%</td>
                    <td class="score-display">${row.querySelector('.scoreEvaluation').value || '0'}</td>
                    <td>${row.querySelector('.reportNotes').value || ''}</td>
                </tr>
                `).join('')}
            </tbody>
        </table>
        
        <h2 class="section-title">KPI DOANH THU MỤC TIÊU</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Chỉ số KPI</th>
                    <th>Đạt chỉ số</th>
                    <th>Điểm KPI %</th>
                    <th>Đánh giá điểm</th>
                    <th>Báo cáo</th>
                </tr>
            </thead>
            <tbody>
                ${Array.from(document.querySelectorAll('#kpiTable2 tbody tr')).map((row, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${row.cells[1].innerHTML.replace(/<[^>]+>/g, '')}</td>
                    <td>${row.cells[2].innerHTML.replace(/<[^>]+>/g, '')}</td>
                    <td class="score-display">${row.cells[3].innerHTML.replace(/<[^>]+>/g, '')}</td>
                    <td class="score-display">${row.querySelector('.kpi2-evaluation').value || '0'}</td>
                    <td>${row.querySelector('.kpi2-report').value || ''}</td>
                </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div>
            <h3>Phân tích báo cáo KPI Doanh thu:</h3>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                ${kpi2NoteEditor.root.innerHTML || 'Không có phân tích'}
            </div>
        </div>
        
        <h2 class="section-title">KPI XÚC TIẾN KHÁCH HÀNG</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Chỉ số KPI</th>
                    <th>Đạt chỉ số</th>
                    <th>Điểm KPI %</th>
                    <th>Đánh giá điểm</th>
                    <th>Báo cáo</th>
                </tr>
            </thead>
            <tbody>
                ${Array.from(document.querySelectorAll('#kpiTable3 tbody tr')).map((row, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${row.cells[1].innerHTML.replace(/<[^>]+>/g, '')}</td>
                    <td>${row.cells[2].innerHTML.replace(/<[^>]+>/g, '')}</td>
                    <td class="score-display">${row.cells[3].innerHTML.replace(/<[^>]+>/g, '')}</td>
                    <td class="score-display">${row.querySelector('.kpi3-evaluation').value || '0'}</td>
                    <td>${row.querySelector('.kpi3-report').value || ''}</td>
                </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div>
            <h3>Phân tích báo cáo KPI Khách hàng:</h3>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                ${kpi3NoteEditor.root.innerHTML || 'Không có phân tích'}
            </div>
        </div>
        
        <h2 class="section-title">KPI GHI NHẬN NỖ LỰC VƯỢT TRỘI</h2>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Chỉ số KPI</th>
                    <th>Đạt chỉ số</th>
                    <th>Điểm KPI %</th>
                    <th>Đánh giá điểm</th>
                    <th>Báo cáo</th>
                </tr>
            </thead>
            <tbody>
                ${Array.from(document.querySelectorAll('#kpiTable4 tbody tr')).map((row, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${row.cells[1].innerHTML.replace(/<[^>]+>/g, '')}</td>
                    <td>${row.cells[2].innerHTML.replace(/<[^>]+>/g, '')}</td>
                    <td class="score-display">${row.cells[3].innerHTML.replace(/<[^>]+>/g, '')}</td>
                    <td class="score-display">${row.querySelector('.kpi4-evaluation').value || '0'}</td>
                    <td>${row.querySelector('.kpi4-report').value || ''}</td>
                </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div>
            <h3>Phân tích báo cáo KPI Nỗ lực:</h3>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                ${kpi4NoteEditor.root.innerHTML || 'Không có phân tích'}
            </div>
        </div>
        
        <div class="signature-box">
            <h3>XÁC NHẬN CỦA NGƯỜI ĐƯỢC ĐÁNH GIÁ</h3>
            <p><strong>Họ và tên:</strong> ${employeeName || 'Chưa ký'}</p>
            <p><strong>Ngày ký:</strong> ${employeeDate || 'Chưa có ngày'}</p>
        </div>
        
        <div class="signature-box">
            <h3>PHÊ DUYỆT CỦA QUẢN LÝ</h3>
            <p><strong>Họ và tên:</strong> ${managerName || 'Chưa ký'}</p>
            <p><strong>Chức vụ:</strong> ${managerPosition || 'Chưa có chức vụ'}</p>
            <p><strong>Ngày phê duyệt:</strong> ${managerDate || 'Chưa có ngày'}</p>
        </div>
        
        <div class="regulation-box">
            <h3>QUY ĐỊNH THƯỞNG KPI</h3>
            <div>${document.querySelector('.border-green-500.bg-green-50').innerHTML}</div>
        </div>
        
        <div class="footer">
            <p>Báo cáo được xuất lúc: ${new Date().toLocaleString('vi-VN')}</p>
            <p>IDECO KPI Management System</p>
        </div>
    </div>
</body>
</html>`;
    
    // Tạo và tải file
    const blob = new Blob([html], { type: 'text/html' });
    const a = document.createElement('a');
    const fileName = `KPI_KD_Report_${creatorName}_${creationDate}.html`;
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
};

// ========== GÁN SỰ KIỆN ==========
addRowBtn.onclick = () => addKpiRow();
saveKpiBtn.onclick = () => saveKpiData();
backToListBtn.onclick = () => { hideForm(); openModal(); };
addNewKpiFromModalBtn.onclick = () => { resetMainForm(); showForm(); closeModal(); };
closeModalBtn.onclick = closeModal;

// Thêm sự kiện tính điểm cho các input
document.addEventListener('DOMContentLoaded', () => {
    initEditors();
    calculateAllScores();
    openModal();
    document.getElementById('creationDate').valueAsDate = new Date();
    document.getElementById('employeeDate').valueAsDate = new Date();
    document.getElementById('managerDate').valueAsDate = new Date();
    
    // Thêm sự kiện tính điểm tự động
    document.querySelectorAll('#kpiTable2 .kpi2-evaluation').forEach(input => {
        input.addEventListener('input', calculateAllScores);
    });
    
    document.querySelectorAll('#kpiTable3 .kpi3-evaluation').forEach(input => {
        input.addEventListener('input', calculateAllScores);
    });
    
    document.querySelectorAll('#kpiTable4 .kpi4-evaluation').forEach(input => {
        input.addEventListener('input', calculateAllScores);
    });
    
    // Thêm hàng mẫu cho bảng 1
    addKpiRow({
        kpiIndicator: 'Mẫu chỉ số KPI (sửa theo thực tế)',
        achievedIndicator: 'Mô tả chỉ số đạt được',
        kpiScore: '10',
        scoreEvaluation: '0',
        reportNotes: 'Báo cáo chi tiết...'
    });
});

// Xử lý click ra ngoài modal
window.onclick = function(event) {
    if (event.target == kpiListModal) {
        closeModal();
    }
};
</script>
</body>
</html>
