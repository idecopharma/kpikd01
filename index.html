<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BẢNG KPI - IDECO (Bản hoàn chỉnh)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- QuillJS Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; }
        .table-container { overflow-x: auto; }
        th, td { border: 1px solid #e5e7eb; padding: 12px; vertical-align: top; }
        th { background: #4f46e5; color: white; position: sticky; top: 0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background:rgba(0,0,0,0.5);}
        .modal-content { background: #fff; margin: 10% auto; padding: 24px; border-radius: 8px; width: 90%; max-width: 600px;}
        .action-button { background: #4f46e5; color: white; padding: 10px 18px; border-radius: 6px; font-weight: 500; border:none; cursor:pointer; }
        .action-button:hover { background: #4338ca; }
        .danger-button { background: #ef4444; }
        .danger-button:hover { background: #dc2626; }
        .secondary-button { background: #6b7280; }
        .secondary-button:hover { background: #4b5563; }
        .framed-info { border: 2px solid #6366f1; border-radius: 14px; background: #f5f3ff; box-shadow: 0 1px 8px #d1d5db33; }
        /* Quill resize */
        .quill-editor {
            min-height: 90px;
            resize: vertical;
            overflow: auto;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 100%;
            margin-bottom: 16px;
        }
        .ql-toolbar.ql-snow {
            border-radius: 8px 8px 0 0;
        }
        .ql-container.ql-snow {
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- FORM KPI -->
    <div class="container mx-auto bg-white p-6 md:p-8 rounded-lg shadow-xl" id="mainKpiForm" style="display: none;">
        <h1 class="text-3xl font-bold text-center mb-8 text-indigo-700">BẢNG KPI KINH DOANH - BÁO CÁO CÔNG VIỆC VÀ CHỈ SỐ KPI CUỐI KỲ THÁNG</h1>
        <div class="framed-info p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label for="creatorName" class="block text-sm font-medium text-gray-700 mb-1">Tên người lập:</label>
                <input type="text" id="creatorName" class="mt-1 block w-full rounded-md shadow-sm">
            </div>
            <div>
                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Bộ phận:</label>
                <input type="text" id="department" class="mt-1 block w-full rounded-md shadow-sm">
            </div>
            <div>
                <label for="creationDate" class="block text-sm font-medium text-gray-700 mb-1">Ngày lập:</label>
                <input type="date" id="creationDate" class="mt-1 block w-full rounded-md shadow-sm">
            </div>
        </div>
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">KPI HOÀN THÀNH NHIỆM VỤ CHUYÊN MÔN (30% ĐIỂM) </h2>
        <div class="table-container mb-8 rounded-lg border border-gray-200">
            <table id="kpiTable" class="min-w-full">
                <thead>
                    <tr>
                        <th>Chỉ số KPI</th>
                        <th>Đạt chỉ số</th>
                        <th>Điểm KPI %</th>
                        <th>Đánh giá điểm</th>
                        <th>Báo cáo</th>
                        <th>Xóa</th>
                    </tr>
                </thead>
                <tbody id="kpiTableBody"></tbody>
            </table>
        </div>
        <button id="addRowBtn" class="action-button mb-8">Thêm hàng KPI</button>

        <!-- BẢNG 2 TĨNH -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-indigo-300 shadow-md">
            <h2 class="text-2xl font-bold text-indigo-700 mb-6">KPI DOANH THU MỤC TIÊU- TĂNG TRƯỞNG DOANH THU TRONG KỲ</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable2" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Chỉ số KPI</th>
                            <th>Đạt chỉ số</th>
                            <th>Điểm KPI %</th>
                            <th>Đánh giá điểm</th>
                            <th>Báo cáo</th>
                        </tr>
                    </thead>
                    <tbody>
                       <tr>
                            <td> <b style="color: red;">A.1 Doanh thu thuốc tổng toàn công ty tối thiểu 1,380,000đồng.</b></td>
                            <td>Đạt từ 100%</td>
                            <td style="color:red; font-weight:bold;"class="kpi2-score">10% </td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
                        <tr>
                            <td> <b style="color: red;">A.2 Doanh thu nhóm không phải thuốc tối thiểu 360 triệu đồng.</b></td>
                            <td>Đạt từ 100%</td>
                            <td style="color:red; font-weight:bold;"class="kpi2-score">10%</td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
                        <tr>
                           <td> B.1 Tỉ lệ tổng doanh thu do bạn lập đơn kỳ này so với kỳ tháng trước không gồm chuỗi nhà thuốc phụ trách.</td>
                            <td>Đạt từ - 10% đến 10% </td>
                            <td class="kpi2-score"> 10%</td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
                       <tr>
                           <td> B.2 Tỉ lệ tổng doanh thu do bạn lập đơn kỳ này so với kỳ tháng trước không gồm chuỗi nhà thuốc phụ trách.</td>
                                                      <td>Đạt từ 10%% đến 40%</td>
                            <td class="kpi2-score"> 25% </td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
						
						<tr>
                           <td> B.3 Tỉ lệ tổng doanh thu do bạn lập đơn kỳ này so với kỳ tháng trước không gồm chuỗi nhà thuốc phụ trách.</td>
                                                        <td>Đạt trên 40%</td>
                            <td style="color:red;font-weight:bold;"class="kpi2-score"> 35% </td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
						<tr>
                           <td> C.1 Tỉ lệ tổng doanh nhóm Chuỗi NT phụ trách kỳ này vs tổng doanh thu nhóm chuỗi NT kỳ trước. </td>
                             <td>Đạt tới 0%</td>
                            <td class="kpi2-score"> 10% </td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
                   
<tr>
                        <td> C.2 Tỉ lệ tổng doanh nhóm Chuỗi NT phụ trách kỳ này vs tổng doanh thu nhóm chuỗi NT kỳ trước .</td>
                             <td>Đạt từ 1% - 20%</td>
                            <td  class="kpi2-score"> 25% </td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
						<td> C.2 Tỉ lệ tổng doanh nhóm Chuỗi NT phụ trách kỳ này vs tổng doanh thu nhóm chuỗi NT kỳ trước. </td>
                             <td>Đạt trên 20%</td>
                            <td style="color:red;font-weight:bold;"class="kpi2-score"> 40% </td>
                            <td><input class="kpi2-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
				   </tbody>
                </table>
            </div>
            <!-- Editor BẢNG 2 -->
            <div class="kpi2-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Phân tích báo cáo cuối kỳ.</label>
                <div id="kpi2NoteEditor" class="quill-editor"></div>
            </div>
        </div>
        <!-- END BẢNG 2 -->

        <!-- BẢNG 3 TĨNH -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-green-300 shadow-md">
            <h2 class="text-2xl font-bold text-green-700 mb-6">KPI PHÁT TRIỂN KHÁCH HÀNG MỚI THÀNH CÔNG.</h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable3" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Chỉ số KPI</th>
                            <th>Đạt chỉ số</th>
                            <th>Điểm KPI %</th>
                            <th>Đánh giá điểm</th>
                            <th>Báo cáo</th>
                        </tr>
                    </thead>
                    <tbody>
						<tr>
                            <td>A.1 Tổng khách hàng mới chốt hợp tác trong kỳ tháng</td>
                            <td> Đạt tối thiểu từ 1  KH </td>
                            <td class="kpi2-score"> 10% </td>
                         <td><input class="kpi3-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>

                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>					
						<tr>
                            <td>A.2 Tổng khách hàng mới chốt hợp tác trong kỳ </td>
                            <td> Đạt tối thiểu từ 4 KH </td>
                            <td style="color:red;font-weight:bold;"class="kpi2-score"> 20% </td>
                            <td><input class="kpi3-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>

                            <td><textarea class="kpi2-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
						
                    </tbody>
                </table>
            </div>
            <!-- Editor BẢNG 3 -->
            <div class="kpi3-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Phân tích báo cáo cuối kỳ:</label>
                <div id="kpi3NoteEditor" class="quill-editor"></div>
            </div>
        </div>
        <!-- END BẢNG 3 -->
        
        <!-- BẢNG 4 TĨNH -->
        <div class="bg-white mt-12 mb-8 p-6 rounded-lg border border-blue-300 shadow-md">
            <h2 class="text-2xl font-bold text-blue-700 mb-6">KPI NỖ LỰC VƯỢT TRỘI THƯỞNG THÊM ĐIỂM </h2>
            <div class="table-container rounded-lg border border-gray-200 mb-6">
                <table id="kpiTable4" class="min-w-full">
                    <thead>
                        <tr>
                            <th>Chỉ số KPI</th>
                            <th>Đạt chỉ số</th>
                            <th>Điểm KPI %</th>
                            <th>Đánh giá điểm</th>
                            <th>Báo cáo</th>
                        </tr>
                    </thead>
                    <tbody>
                        
                    						
						 <tr>
                            <td><b style="color:green;"> A.1 Khách hàng đặt hàng nhóm không phải thuốc</b></td>
                            <td>Từ 1 đến 6 khách hàng</td>
                            <td class="kpi4-score">10%</td>
                            <td><input class="kpi4-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr
						<tr>
                            <td><b style="color:green;"> A.2 Khách hàng đặt hàng nhóm không phải thuốc.</b></td>
                            <td>Từ 7 khách hàng </td>
                            <td style="color:red;font-weight:bold; "class="kpi4-score"> 30%</td>
                            <td><input class="kpi4-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
						<tr>
                            <td><b style="color:green;"> A.3 Thưởng thêm điểm KPI cho nỗ lực giới thiệu UVS Nailcare; UVS Silicone gel; UVS Cremelas; UVS Rasskee;UVS Bionee.</b></td>
                            <td>Từ 1 khách hàng có đơn một trong 4 sản phẩm trên từ 12 tuýp mỗi loại </td>
                            <td style="color:red;font-weight:bold; "class="kpi4-score"> 10%</td>
                            <td><input class="kpi4-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
			
					<tr>
                            <td><b style="color:green;"> A.3 Thưởng thêm điểm KPI cho nỗ lực giới thiệu UVS Nailcare; UVS Silicone gel; UVS Cremelas; UVS Rasskee;UVS Bionee.</b></td>
                            <td>Từ 1 khách hàng có đơn một trong 4 sản phẩm trên từ 24 tuýp mỗi loại </td>
                            <td style="color:red;font-weight:bold; "class="kpi4-score"> 25%</td>
                            <td><input class="kpi4-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
					
					
					<tr>
                            <td><b style="color:green;"> A.3 Tổng số sản phâm đặt thuốc của Long Châu + Pharmacity trong kỳ</b></td>
                            <td>Tỉ lệ tổng 2 chuỗi có số sản phẩm đặt trong kỳ > 70% tổng số thuốc đã vào  </td>
                            <td style="color:red;font-weight:bold; "class="kpi4-score"> 25%</td>
                            <td><input class="kpi4-evaluation w-full border rounded-md p-1 text-center" type="number" value="0"></td>
                            <td><textarea class="kpi4-report w-full border rounded-md p-1" rows="1">Em tự đánh giá</textarea></td>
                        </tr>
					
						
						
						
						
						
						
						
						
						
                    </tbody>
                </table>
            </div>
            <div class="kpi4-note-section mt-4">
                <label class="block font-semibold text-gray-700 mb-2">Phân tích báo cáo cuối kỳ:</label>
                <div id="kpi4NoteEditor" class="quill-editor"></div>
            </div>
			<!-- Quy định/nhận xét cuối bảng tĩnh KPI 3 -->

        </div>
		<div class="mt-4 p-4 border border-dashed border-green-500 bg-green-50 rounded-xl shadow-sm">
  <div class="font-semibold mb-2 text-green-700">QUY ĐỊNH THƯỞNG KPI - TÍNH THƯỞNG HOA HỒNG </div>
  <div class="text-gray-700 leading-relaxed">
  <p><b>ĐIỂM KPI TĂNG SẼ TĂNG THU NHẬP TÍNH ĐIỂM KPI - KPI CÓ THỂ HƠN 100% ĐIỂM CHUẨN</b></p><br>
  
    <p><b>1.</b> Thành công 1 Nhà thuốc cho thuốc có tổng giá trị đặt hàng tối thiểu <b>2,6 triệu đồng</b> - thưởng <b>200,000 đồng</b>.</p>
<p><b>2.</b> Thành công 1 Nhà thuốc cho nhóm không thuốc có tổng giá trị đặt hàng từ <b>2,6 triệu đồng</b> - thưởng <b>400,000 đồng</b>.</p>
<p><b>3.</b> Thành công 1 NPP cho nhóm không thuốc có tổng giá trị đặt hàng từ <b> 8 triệu đồng/đơn</b> - thưởng <b>1 triệu đồng</b>.</p>
<p><b>4.</b> Mở  chuỗi Nhà Thuốc mới có lên đơn tối thiểu <b> 5 triệu đồng</b> thưởng <b>800,000 đồng</b>.</p>
<p><b>5.</b> Mở thành công NT trong phòng khám - có đặt hàng có giá trị tối thiểu <b> 5 triệu đồng</b> - thưởng <b>800,000 đồng</b>.</p>

<u>
  <li>a. Cho phép cộng dồn 2 đơn hàng trong thời gian tối đa <b>20 ngày</b> để có tổng giá trị đơn đạt mức thưởng trên và trả tại thời điểm đơn cuối.</li>
  <li>b. Công ty tính thưởng trên báo cáo cuối kỳ của nhân viên đúng theo quy định và có xác nhận từ bộ phận kế toán - cấp quản lý kinh doanh.</li>
  <li>c. Đối với 1 Nhà thuốc có cùng tư cách pháp nhân khi mở chi nhanh mới thì chi nhánh mới không được tính là mở 1 nhà thuốc mới vì đă dược tính vào doanh thu đặt hàng chung rồi</li>
  <li>d. GHI CHÚ: DOANH THU TÍNH TỈ LỆ TĂNG TRƯỞNG Ở MỤC KPI : LÀ DOANH THU GỘP ( GỒM CẢ CÔNG NỢ) </li>
  <li>d. GHI CHÚ: NHÂN VIÊN KINH DOANH PHẢI BÁO CÁO CÁC CHỈ SỐ KPI TRÊN TRONG BÁO CÁO CUỐI THÁNG MỚI NHẬN THƯỞNG KPI KHI XEM XÉT ĐÁNH GIÁ </li>
  
  
</u>

<p><b>HOA HỒNG  ĐƯỢC TÍNH CHO KHÁCH HÀNG DO NHÂN VIÊN KHAI THÁC TRỰC TIẾP VÀ TÍNH LŨY KÊ DOANH THU TẠI THỜI ĐIỂM TRONG KỲ THÁNG</b></p><br>

<p><b>a. Doanh Thu nhóm không phải thuốc:</b><br>
- Doanh thu theo đơn hàng từ <b>3triệu đồng</b> - hoa hồng <b>2.5%</b><br>
- Doanh thu theo đơn hàng từ <b>16 triệu đồng</b> - hoa hồng <b>3.5%</b><br>
- Doanh thu theo đơn hàng từ <b>30 triệu đồng</b> - hoa hồng <b>5%</b>
- Doanh thu theo đơn hàng từ <b>60 triệu đồng</b> - hoa hồng <b>6.5</b>
</p>

<p><b>b. Doanh thu nhóm thuốc:</b><br>
- Doanh thu theo đơn hàng từ <b>2 triệu đồng</b> - hoa hồng <b>1.5%</b><br>
- Doanh thu theo đơn hàng từ <b>30 triệu đồng</b> - hoa hồng <b>2%</b><br>
- Doanh thu theo đơn hàng từ <b>60 triệu đồng</b> - hoa hồng <b>3.5%</b>
</p>


<p><u>Ghi chú:</u> doanh thu tính trên người lập đơn trên ERP và báo cáo cuối tháng để làm căn cứ tính.</p><br>


 <p><b>1.</b> Lỗi nhắc nhở sai sót khai báo giao dịch khách hàng không đúng quá 3 lần/tháng <b> Trừ 8% điểm KPI</b>.</p>
	   <P><b>2.</b> Không báo cáo nhanh cuối tuần theo quy định mỗi báo cáo cuối tuần không viết- nộp  <b> Trừ 8% điêm KPI</b></p>
<p><b>3.</b> Lỗi báo cáo Cuối Tháng theo quy định trễ hay bị buột phải làm lại do sai sót nhiều <b> Trừ 6 điểm KPI</b>.</p>
<p><b>4.</b> Lỗi sai sót đơn hàng- khai báo đơn hàng quá 3 lần/ tháng <b> Trứ 6 điểm KPI </b>.</p>
<p><b>5.</b> Lỗi không tuân thủ quy định lập kế hoạch định kỳ 4 tuần có 4 bảng kế hoạch  <b> Trừ 8 điểm KPI </b>.</p>
<p><b>6.</b> Lỗi sai khác không đúng quy định công ty đề ra hay ban hành trước đó <b> Trứ điểm 8 điểm KPI/1 lần nhắc</b>.</p>

	
	
  </div>
</div>

        <!-- END BẢNG 4 -->

        <!-- Tổng điểm KPI -->
        <div class="container mx-auto bg-white mb-12 p-6 rounded-lg shadow flex justify-end">
            <div class="text-right">
                <span class="font-semibold text-lg">TỔNG ĐIỂM KPI (cộng tất cả các ô Đánh giá điểm): </span>
                <span class="font-bold text-indigo-600 text-2xl" id="total-evaluation-score">0</span>
            </div>
        </div>

        <div class="flex flex-wrap gap-4 justify-center md:justify-start">
            <button id="saveKpiBtn" class="action-button">Lưu lại</button>
            <button id="exportPdfBtn" class="action-button secondary-button">Xuất file PDF</button>
            <button id="backToListBtn" class="action-button secondary-button">Quay lại Danh sách</button>
			<button id="exportHtmlBtn" class="action-button secondary-button">Xuất file gởi điểm KPI </button>

        </div>
    </div>

    <!-- MODAL DANH SÁCH KPI -->
    <div id="kpiListModal" class="modal">
        <div class="modal-content">
            <span class="float-right text-xl cursor-pointer" id="closeModalBtn">&times;</span>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">KPI PHỤ TRÁCH KINH DOANH</h2>
            <button id="addNewKpiFromModalBtn" class="action-button mb-6 w-full">Thêm mới Bảng KPI</button>
            <!-- Thêm nút ERP HOME -->
            <a href="https://erp-ideco.skyit.vn/#/app/dashboard/main" target="_blank" class="action-button secondary-button mb-4 w-full text-center block">ERP HOME</a>
            <div id="savedKpiList" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDa84ErhJfqyirTNNeLkZEuVz--q6IK5TQ",
  authDomain: "kpikdchuyenvien.firebaseapp.com",
  projectId: "kpikdchuyenvien",
  storageBucket: "kpikdchuyenvien.firebasestorage.app",
  messagingSenderId: "520992882938",
  appId: "1:520992882938:web:ea9842cbd2cb1b5f340943",
  measurementId: "G-HJ7X958PLV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const mainKpiForm = document.getElementById('mainKpiForm');
const kpiTableBody = document.getElementById('kpiTableBody');
const addRowBtn = document.getElementById('addRowBtn');
const saveKpiBtn = document.getElementById('saveKpiBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const backToListBtn = document.getElementById('backToListBtn');
const kpiListModal = document.getElementById('kpiListModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const savedKpiListDiv = document.getElementById('savedKpiList');
const addNewKpiFromModalBtn = document.getElementById('addNewKpiFromModalBtn');
let currentKpiId = null;

// --- QuillJS Editor toolbar config ---
const quillToolbar = [
  ['bold', 'italic', 'underline', 'strike'],
  [{ 'font': [] }],
  [{ 'size': ['small', false, 'large', 'huge'] }],
  [{ 'align': [] }],
  [{ 'color': [] }, { 'background': [] }],
  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
  ['clean']
];

let kpi2NoteEditor, kpi3NoteEditor, kpi4NoteEditor;

// Khởi tạo editor sau khi DOM loaded
function initEditors() {
    kpi2NoteEditor = new Quill('#kpi2NoteEditor', {
      modules: { toolbar: quillToolbar },
      theme: 'snow'
    });
    kpi3NoteEditor = new Quill('#kpi3NoteEditor', {
      modules: { toolbar: quillToolbar },
      theme: 'snow'
    });
    kpi4NoteEditor = new Quill('#kpi4NoteEditor', {
      modules: { toolbar: quillToolbar },
      theme: 'snow'
    });
}
function resetEditors() {
    kpi2NoteEditor.root.innerHTML = '';
    kpi3NoteEditor.root.innerHTML = '';
    kpi4NoteEditor.root.innerHTML = '';
}

function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9) + Date.now();
}
function showForm() { mainKpiForm.style.display = 'block'; }
function hideForm() { mainKpiForm.style.display = 'none'; }
function openModal() { displaySavedKpis(); kpiListModal.style.display = 'block'; }
function closeModal() { kpiListModal.style.display = 'none'; }

function addKpiRow(data = {}) {
    const row = kpiTableBody.insertRow();
    row.innerHTML = `
        <td><textarea class="kpiIndicator w-full p-2 border rounded-md" placeholder="Mô tả chỉ số">${data.kpiIndicator||''}</textarea></td>
        <td><input type="text" class="achievedIndicator w-full p-2 border rounded-md" value="${data.achievedIndicator||''}"></td>
        <td><input type="number" class="kpiScore w-full p-2 border rounded-md" value="${data.kpiScore||''}"></td>
        <td><input type="number" class="scoreEvaluation w-full p-2 border rounded-md" value="${data.scoreEvaluation||''}"></td>
        <td><textarea class="reportNotes w-full p-2 border rounded-md">${data.reportNotes||''}</textarea></td>
        <td class="text-center"><button class="deleteRowBtn danger-button text-xs px-2 py-1">Xóa</button></td>
    `;
    row.querySelector('.deleteRowBtn').onclick = ()=>{ row.remove(); calcTotalEvaluationScore(); };
    row.querySelector('.scoreEvaluation').addEventListener('input', calcTotalEvaluationScore);
}

addRowBtn.onclick = ()=>addKpiRow();

function saveKpiData() {
    const creatorName = document.getElementById('creatorName').value.trim();
    const department = document.getElementById('department').value.trim();
    const creationDate = document.getElementById('creationDate').value;
    if (!creatorName || !department || !creationDate) {
        alert('Vui lòng nhập đầy đủ Tên người lập, Bộ phận và Ngày lập.');
        return false;
    }
    const kpiRowsData = [];
    const rows = kpiTableBody.querySelectorAll('tr');
    rows.forEach(row=>{
        const kpiIndicator = row.querySelector('.kpiIndicator').value;
        const achievedIndicator = row.querySelector('.achievedIndicator').value;
        const kpiScore = row.querySelector('.kpiScore').value;
        const scoreEvaluation = row.querySelector('.scoreEvaluation').value;
        const reportNotes = row.querySelector('.reportNotes').value;
        kpiRowsData.push({kpiIndicator, achievedIndicator, kpiScore, scoreEvaluation, reportNotes});
    });
    const kpi2RowsData = [];
    const kpi2Rows = document.querySelectorAll('#kpiTable2 tbody tr');
    kpi2Rows.forEach(row=>{
        const kpiIndicator = row.querySelector('td:first-child').innerText;
        const achievedIndicator = row.querySelector('td:nth-child(2)').innerText;
        const kpiScore = row.querySelector('.kpi2-score').innerText;
        const scoreEvaluation = row.querySelector('.kpi2-evaluation').value;
        const reportNotes = row.querySelector('.kpi2-report').value;
        kpi2RowsData.push({kpiIndicator, achievedIndicator, kpiScore, scoreEvaluation, reportNotes});
    });
    const kpi3RowsData = [];
    const kpi3Rows = document.querySelectorAll('#kpiTable3 tbody tr');
    kpi3Rows.forEach(row=>{
        const kpiIndicator = row.querySelector('td:first-child').innerText;
        const achievedIndicator = row.querySelector('td:nth-child(2)').innerText;
        const kpiScore = row.querySelector('.kpi2-score').innerText;
        const scoreEvaluation = row.querySelector('.kpi3-evaluation').value;
        const reportNotes = row.querySelector('.kpi2-report').value;
        kpi3RowsData.push({kpiIndicator, achievedIndicator, kpiScore, scoreEvaluation, reportNotes});
    });
    const kpi4RowsData = [];
    const kpi4Rows = document.querySelectorAll('#kpiTable4 tbody tr');
    kpi4Rows.forEach(row=>{
        const kpiIndicator = row.querySelector('td:first-child').innerText;
        const achievedIndicator = row.querySelector('td:nth-child(2)').innerText;
        const kpiScore = row.querySelector('.kpi4-score').innerText;
        const scoreEvaluation = row.querySelector('.kpi4-evaluation').value;
        const reportNotes = row.querySelector('.kpi4-report').value;
        kpi4RowsData.push({kpiIndicator, achievedIndicator, kpiScore, scoreEvaluation, reportNotes});
    });
    const kpiData = {
        creatorName, department, creationDate,
        kpiRows: kpiRowsData,
        kpi2Rows: kpi2RowsData,
        kpi3Rows: kpi3RowsData,
        kpi4Rows: kpi4RowsData,
        kpi2Note: kpi2NoteEditor.root.innerHTML,
        kpi3Note: kpi3NoteEditor.root.innerHTML,
        kpi4Note: kpi4NoteEditor.root.innerHTML,
        totalEvaluationScore: document.getElementById('total-evaluation-score').innerText,
        lastModified: new Date().toISOString()
    };
    if (!currentKpiId) currentKpiId = generateId();
    db.ref('kpis/' + currentKpiId).set(kpiData)
        .then(()=>{ alert('Đã lưu thành công!'); displaySavedKpis(); })
        .catch(error=>{ alert('Lỗi khi lưu: ' + error.message); });
}

function loadKpiData(kpiId) {
    db.ref('kpis/' + kpiId).once('value').then(snapshot=>{
        const data = snapshot.val();
        if (!data) return;
        document.getElementById('creatorName').value = data.creatorName || '';
        document.getElementById('department').value = data.department || '';
        document.getElementById('creationDate').value = data.creationDate || '';
        kpiTableBody.innerHTML = '';
        if (data.kpiRows) data.kpiRows.forEach(row=>addKpiRow(row));
        if (data.kpi2Rows) {
            data.kpi2Rows.forEach((rowData, index)=>{
                const row = document.querySelectorAll('#kpiTable2 tbody tr')[index];
                if (row) {
                    row.querySelector('.kpi2-evaluation').value = rowData.scoreEvaluation || 0;
                    row.querySelector('.kpi2-report').value = rowData.reportNotes || '';
                }
            });
        }
        if (data.kpi3Rows) {
            data.kpi3Rows.forEach((rowData, index)=>{
                const row = document.querySelectorAll('#kpiTable3 tbody tr')[index];
                if (row) {
                    row.querySelector('.kpi3-evaluation').value = rowData.scoreEvaluation || 0;
                    row.querySelector('.kpi2-report').value = rowData.reportNotes || '';
                }
            });
        }
        if (data.kpi4Rows) {
            data.kpi4Rows.forEach((rowData, index)=>{
                const row = document.querySelectorAll('#kpiTable4 tbody tr')[index];
                if (row) {
                    row.querySelector('.kpi4-evaluation').value = rowData.scoreEvaluation || 0;
                    row.querySelector('.kpi4-report').value = rowData.reportNotes || '';
                }
            });
        }
        if (data.kpi2Note) kpi2NoteEditor.root.innerHTML = data.kpi2Note;
        if (data.kpi3Note) kpi3NoteEditor.root.innerHTML = data.kpi3Note;
        if (data.kpi4Note) kpi4NoteEditor.root.innerHTML = data.kpi4Note;
        calcTotalEvaluationScore();
        currentKpiId = kpiId;
        showForm();
        closeModal();
    }).catch(error=>{ alert('Lỗi khi tải dữ liệu: ' + error.message); });
}

function displaySavedKpis() {
    db.ref('kpis').once('value').then(snapshot=>{
        const kpis = snapshot.val();
        savedKpiListDiv.innerHTML = '';
        if (!kpis) {
            savedKpiListDiv.innerHTML = '<p class="text-gray-500">Chưa có bảng KPI nào được lưu.</p>';
            return;
        }
        Object.entries(kpis).forEach(([id, data])=>{
            const div = document.createElement('div');
            div.className = 'p-3 border border-gray-300 rounded-lg bg-white shadow-sm';
            div.innerHTML = `
                <div class="font-semibold">${data.creatorName} - ${data.department}</div>
                <div class="text-sm text-gray-600">Ngày lập: ${data.creationDate}</div>
                <div class="text-sm text-gray-600">Tổng điểm: ${data.totalEvaluationScore || 0}</div>
                <div class="text-sm text-gray-500">Sửa lần cuối: ${new Date(data.lastModified).toLocaleString('vi-VN')}</div>
                <div class="mt-2 flex gap-2">
                    <button class="loadBtn action-button text-xs px-2 py-1">Tải</button>
                    <button class="deleteBtn danger-button text-xs px-2 py-1">Xóa</button>
                </div>
            `;
            div.querySelector('.loadBtn').onclick = ()=>loadKpiData(id);
            div.querySelector('.deleteBtn').onclick = ()=>deleteKpi(id, div);
            savedKpiListDiv.appendChild(div);
        });
    }).catch(error=>{ alert('Lỗi khi tải danh sách: ' + error.message); });
}

function deleteKpi(kpiId, element) {
    if (confirm('Bạn có chắc muốn xóa bảng KPI này?')) {
        db.ref('kpis/' + kpiId).remove()
            .then(()=>{ element.remove(); })
            .catch(error=>{ alert('Lỗi khi xóa: ' + error.message); });
    }
}

function calcTotalEvaluationScore() {
    let total = 0;
    document.querySelectorAll('.scoreEvaluation').forEach(input=>{ total += Number(input.value) || 0; });
    document.querySelectorAll('.kpi2-evaluation').forEach(input=>{ total += Number(input.value) || 0; });
    document.querySelectorAll('.kpi3-evaluation').forEach(input=>{ total += Number(input.value) || 0; });
    document.querySelectorAll('.kpi4-evaluation').forEach(input=>{ total += Number(input.value) || 0; });
    document.getElementById('total-evaluation-score').innerText = total;
}

function exportToPdf() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');
    const element = document.getElementById('mainKpiForm');
    html2pdf().from(element).set({
        margin: 10,
        filename: 'BaoCaoKPI.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).save();
}
function exportToHtml() {
    const element = document.getElementById('mainKpiForm');
    const htmlContent = element.outerHTML;
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'BaoCaoKPI.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// --- Event Listeners ---
saveKpiBtn.onclick = saveKpiData;
exportPdfBtn.onclick = exportToPdf;
exportHtmlBtn.onclick = exportToHtml;
backToListBtn.onclick = ()=>{ hideForm(); openModal(); };
closeModalBtn.onclick = closeModal;
addNewKpiFromModalBtn.onclick = ()=>{
    currentKpiId = null;
    document.getElementById('creatorName').value = '';
    document.getElementById('department').value = '';
    document.getElementById('creationDate').value = '';
    kpiTableBody.innerHTML = '';
    resetEditors();
    document.querySelectorAll('.kpi2-evaluation, .kpi3-evaluation, .kpi4-evaluation').forEach(input=>{ input.value = 0; });
    document.querySelectorAll('.kpi2-report, .kpi4-report').forEach(textarea=>{ textarea.value = 'Em tự đánh giá'; });
    calcTotalEvaluationScore();
    showForm();
    closeModal();
};

// --- Initialize ---
document.addEventListener('DOMContentLoaded', ()=>{
    initEditors();
    openModal();
    calcTotalEvaluationScore();
    document.querySelectorAll('.scoreEvaluation, .kpi2-evaluation, .kpi3-evaluation, .kpi4-evaluation').forEach(input=>{
        input.addEventListener('input', calcTotalEvaluationScore);
    });
});
</script>
</body>
</html>
